<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="TinyLab" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="TinyLab">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="TinyLab">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TinyLab">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/9/"/>


  <title> TinyLab </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?32177a2b43f11f13565131b8c1239878";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">TinyLab</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Keep eyes on the star and feet on the ground.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/04/27/LMS/" itemprop="url">
                  什么是滤波器？
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-04-27T05:42:00+08:00" content="2008-04-27">
              2008-04-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/课程设计/" itemprop="url" rel="index">
                    <span itemprop="name">课程设计</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/04/27/LMS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/04/27/LMS/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>帮同学编个LMS（Least Mean Squre）自适应滤波器算法，有许多基本概念都不知道，所以就上网搜了搜，长长见识。</p>
<p>滤波器是一种用来消除干扰杂讯的器件，将输入或输出经过过滤而得到纯净的交流电。您可以通过基本的滤波器积木块——二阶通用滤波器传递函数，推导出最通用的滤波器类型：低通、带通、高通、陷波和椭圆型滤波器。</p>
<p>传递函数的参数——f0、d、hHP、hBP 和hLP，可用来构造所有类型的滤波器。转降频率f0为s项开始占支配作用时的频率。设计者将低于此值的频率看作是低频，而将高于此值的频率看作是高频，并将在此值附近的频率看作是带内频率。阻尼d用于测量滤波器如何从低频率转变至高频率，它是滤波器趋向振荡的一个指标。实际阻尼值从0至2变化（表1）。高通系数hHP是对那些高于转降频率的频率起支配作用的分子的系数。带通系数hBP是对那些在转降频率附近的频率起支配作用的分子的系数。低通系数hLP是对那些低于转降频率的频率起支配作用的分子的系数。设计者只需这5个参数即可定义一个滤波器。</p>
<h3 id="滤波器的过去、现在与未来"><a href="#滤波器的过去、现在与未来" class="headerlink" title="滤波器的过去、现在与未来"></a>滤波器的过去、现在与未来</h3><p>凡是有能力进行信号处理的装置都可以称为滤波器。在近代电信装备和各类控制系统中，滤波器应用极为广泛；在所有的电子部件中，使用最多，技术最复杂要算滤波器了。滤波器的优劣直接决定产品的优劣，所以，对滤波器的研究和生产历来为各国所重视。</p>
<h3 id="滤波器的发展过程"><a href="#滤波器的发展过程" class="headerlink" title="滤波器的发展过程"></a>滤波器的发展过程</h3><p>1917年美国和德国科学家分别发明了LC滤波器，次年导致了美国第一个多路复用系统的出现。50年代无源滤波器日趋成熟。自60年代起由于计算机技术、集成工艺和材料工业的发展，滤波器发展上了一个新台阶，并且朝着低功耗、高精度、小体积、多功能、稳定可靠和价廉方向努力，其中小体积、多功能、高精度、稳定可靠成为70年代以后的主攻方向，导致RC有源滤波器 、数字滤波器、开关电容滤波器和电荷转移器等各种滤波器的飞速发展。到70年代后期，上述几种滤波器的单片集成被研制出来并得到应用。80年代致力于各类新型滤波器性能提高的研究并逐渐扩大应用范围。90年代至今在主要致力于把各类滤波器应用于各类产品的开发和研制。当然，对滤波器本身的研究仍在不断进行。</p>
<p>我国广泛使用滤波器是50年代后的事，当时主要用于话路滤波和报路滤波。经过半个世纪的发展，我国滤波器在研制、生产应用等方面已有一定进步，但由于缺少专门研制机构，集成工艺和材料工业跟不上来，使许多新型滤波器的研制应用与国际水平有一段距离。</p>
<h3 id="滤波器分类"><a href="#滤波器分类" class="headerlink" title="滤波器分类"></a>滤波器分类</h3><h4 id="按处理信号类型分类"><a href="#按处理信号类型分类" class="headerlink" title="按处理信号类型分类"></a>按处理信号类型分类</h4><p>滤波器可分为模拟滤波器和离散滤波器两大类。其中模拟滤波器又可分为有源、无源、异类三个分类；离散滤波器又可分为数字、取样模拟、混合三个分类。当然，每个分类又可继续分下去，总之，它们的分类可以形成一个树形结构。</p>
<p><strong>按选择物理量分类</strong></p>
<p>滤波器可分为频率选择、幅度选择、时间选择（例如PCM制中的话路信号）和信息选择（例如匹配滤波器）等四类滤波器。</p>
<p><strong>按频率通带范围分类</strong></p>
<p>滤波器可分为低通、高通、带通、带阻、全通五个类别，而梳形滤波器属于带通和带阻滤波器，因为它有周期性的通带和阻带。</p>
<p>滤波器种类繁多，下面着重介绍近年来发展很快的几种滤波器。</p>
<p><strong>有源滤波器</strong></p>
<p>有源滤波器由下列一些有源元件组成：运算放大器、负电阻、负电容、负电感、频率变阻器（FDNR）、广义阻抗变换器（GIC）、负阻抗变换器（NIC）、正阻抗变换器（PIC）、负阻抗倒置器（NII）、正阻抗倒置器（PII）、四种受控源，另外，还有病态元件极子和零子。</p>
<p>1965年单片集成运算放大器问世后，为有源滤波器开辟了广阔的前景，到70年代初期，有源滤波器发展最为注目，1978年单片RC有源滤波器问世，为滤波器集成迈进了可喜的一步。由于运放的增益和相移均为频率的函数，这就限制了RC有源滤波器的频率范围，一般工作频率为20KHz左右，经过补偿后，工作频率也限制在100KHz以内。1974年产生了有源滤波器，使工作频率可达GB/4（GB为运放增益与带宽之积）。由于R(电阻)的存在，给集成工艺造成困难，于是又出现了有源C(电容)滤波器：就是说，滤波器由C和运放组成。这样容易集成，更重要是提高了滤波器的精度，因为有源C滤波器的性能只取决于电容之比，与电容绝对值无关。但它有一个主要问题：由于各支路元件均为电容，所以运放没有直流反馈通道，使稳定性成为难题。1982年由Geiger、Allen和Ngo提出用连续的开关电阻（SR）去替代有源RC滤波器中的电阻R，就构成了SRC滤波器，它仍属于模拟滤波器。但由于采用预置电路和复杂的相位时钟，这种滤波器发展前途不大。</p>
<p>总之，以RC有源滤波器为原型的各类变种有源滤波器去掉了电感器，体积小，Q值可达1000，克服了RLC无源滤波器体积大、Q值小的缺点。但它仍有许多课题有待进一步研究：理想运放与实际特性的偏差；由于有源滤波器混合集成工艺的不断改进，单片集成有待进一步研究；应用线性变换方法探索最少有源元件的滤波器需要继续探索；元件的绝对值容差的存在，影响滤波器精度和性能等问题仍未解决；由于R存在，占芯片面积大、电阻误差大(20~30%)、线性度差等缺点，大规模集成仍然有困难。</p>
<p><strong>开关电容滤波器（SCF）</strong></p>
<p>80年代技术改造一个重大课题是实现各种电子系统全面大规模集成（LSI），使用最多的滤波器成为”拦路虎”，RC有源滤波器不能实现LSI，无源滤波器和机械滤波器更不用说。人们只能另辟新径。50年代有人提出SCF的概念，由于当时集成工艺不过关，并没有引起人们的重视，直到72年，美国一个叫Fried的科学家用开关和电容模拟电阻R，说SCF的性能只取决于电容之比，与电容绝对值无关，这样才引起人们的重视。1979年一些发达国家单片SCF已成为商品（属于高度保密技术），现在SC技术已趋成熟。SCF并用MOS工艺加以实现公认为80年代网络理论与集成工艺的一大突破。当前MOS电容值一般为几PF~100PF之内，它具有（10~100） 10-6/V的电压系数与（10~100） 10-6/℃的温度系数，这两个系数几乎接近理想的境界。SCF具有下列一些优点：可以大规模集成；精度高；功能多，几乎所有电子部件和功能均可以由SC技术来实现；比数字滤波器简单，因为不需要A/D，D/A转换；功能小，可以做到。</p>
<p>SCF的应用情况：以声频范围应用为主体，工作频率在100KHz之内；在信号处理方面的应用有：程控SCF、模拟信号处理、振动分析、自适应性滤波器、音乐综合、共振谱、语言综合器、音调选择、语声编码、声频分析、均衡器、解调器、锁相电路、离散傅氏变换……。总之，SCF在仪表测量、医疗仪器、数据或信息处理等许多领域都有广泛的应用前景。</p>
<p>在我国，1978年，有的导师和在校研究生开始进行这项研究工作，真正引起人们重视是80年以后。83年清华大学已制成单片SCF，成都工程学院与工厂联合，也研制成单片SCF。现在关键是MOS工艺实现SCF及推广应用问题，由于用户还不了解它，SCF的应用还没有普及。</p>
<p>SCF还有许多课题有待研究：1、由于运放和控制MOS开关的采样频率所限制，SCF只能在音频范围内应用。近年虽然出现无运放的SC电路，但由于采样频率的限制，工作频率最高只在1MHZ之内。2、非零的MOS开关的沟道电阻以及非理想的运放特性，均可使SCF造成误差。3、开关电容本身的寄生电容将使SCF的频响发生畸变。4、MOS开关与MOS运放的热噪声将使SCF的动态范围受到限制。5、最终要以MOS工艺来实现的SCF，由于它是时变网络，想用分立元件精确模拟是不可能的，因此，设计完善的CAD技术是解决这一问题的唯一手段。此外，在灵敏度分析、噪声分析等方面均有许多课题有待研究。</p>
<h3 id="几种新型数字滤波器（DF）"><a href="#几种新型数字滤波器（DF）" class="headerlink" title="几种新型数字滤波器（DF）"></a>几种新型数字滤波器（DF）</h3><p>大家对DF并不陌生，这里不作系统综述，但对一些新型DF做一些介绍：</p>
<p>1.自适应DF</p>
<p>最优控制、自适应控制和自学习控制都涉及到多参数、多变量的复杂控制系统，都属于现代控制理论研究的课题。自适应DF具有很强的自学习、自跟踪功能。它在雷达和声纳的波束形成、缓变噪声干扰的抑制、噪声信号的处理、通信信道的自适应均衡、远距离电话的回声抵消等领域获得了广泛的应用，促进了现代控制理论的发展。</p>
<p>自适应DF有如下一些简单算法：W-LMS算法；M-LMS算法；TDO算法；差值LMS算法和C-LMS算法。</p>
<p>2.复数DF</p>
<p>在输入信号为窄带信号处理系统中，常采用复数DF技术。为了降低采样率而保存信号所包含的全部信息，可利用正交双路检波法，取出窄带信号的复包络，然后通过A/D变换，将复包络转化为复数序列进行处理，这个信号处理系统即为复数DF。它具有许多功能。MTI雷达中抑制具有卜勒频移的杂波干扰；数字通信网与模拟通信网之间多路TDM/FDM信号变换复接等等。</p>
<p>3.多维DF<br>在图象处理、地震、石油勘探的数据处理中都用到多维DF（常用是二维DF），多维DF的设计，往往将一维DF优化设计直接推广到多维DF中去。对于模糊和随机噪声干扰的二维图象的处理，多维DF也能发挥很好的作用。</p>
<p>此外，还有波DF，它便于实现大规模集成；便于无源和有源滤波网络的数字模拟。</p>
<p>对于DF有待研究的课题有：系数灵敏度；舍入噪声和极限环；多维逆归滤波器的稳定性；各种硬件和软件实现DF的研究等等。</p>
<h3 id="其它新型滤波器"><a href="#其它新型滤波器" class="headerlink" title="其它新型滤波器"></a>其它新型滤波器</h3><p>介绍几种已得到广泛应用的新型滤波器：</p>
<p>1.电控编程CCD横向滤波器（FPCCDTF）</p>
<p>电荷耦合器（CCD）固定加权的横向滤波器（TF）在信号处理中，其性能和造价均可与数字滤波器和各种信号处理部件媲美。这种滤波器主要用于自适应滤波；P-N序列和Chirp波形的匹配滤波；通用化的频域滤波器以及作相关、褶积运算；语音信号和相位均衡；相阵系统的波束合成和电视信号的重影消除等。</p>
<p>2.晶体滤波器</p>
<p>它是适应单边带技术而发展起来的。在70年代，集成晶体滤波器的产生，使它发展产生一个飞跃，近十年来，对晶体滤波器致力于下面一些研究：实现最佳设计，除具有优良的选择外，还具有良好的时域响应；寻求新型材料；扩展工作频率；改造工艺，使其向集成化发展。它广泛应用于多路复用系统中作为载波滤波器，在收发信中、单边带通信机中作为选频滤波器，在频谱分析仪和声纳装置中作为中频滤波器。</p>
<p>3.声表面波滤波器</p>
<p>它是理想的超高频器件。它的幅频特性和相位特性可以分别控制，以达到要求，体积小，长时间稳定性好和工艺简单。通常应用于：电视广播发射机中作为残留边带滤波器；彩色电视接收机中调谐系统的表面梳形滤波器，此外，在国防卫星通信系统中已广泛采用。声表面波滤波器是电子学和声学相结合的产物，而且可以集成。所以，它在所有无源滤波器中最有发展前途。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/04/20/psp-development-enviroment/" itemprop="url">
                  PSP游戏开放环境的建立
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-04-20T17:30:00+08:00" content="2008-04-20">
              2008-04-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/游戏开发/" itemprop="url" rel="index">
                    <span itemprop="name">游戏开发</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/04/20/psp-development-enviroment/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/04/20/psp-development-enviroment/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre><code>说明：原文见于http://www.psp-programming.com/tutorials/c/lesson01.htm  
初次翻译，错误难免，还请见谅。
</code></pre><p>我们有一系列关于如何自制PSP（Playstation Potable）软件的教程，这份将是第一期。如果你正在读这个，恭喜你，作为程序员你遇到了一个大障碍。和刚开始编程时遇到的麻烦一样。好了，开始阅读教程了。</p>
<p>要创建你自己的程序，第一步就是要建立开发环境。该开发环境能可以将源代码编译成可以在PSP上执行的文件。我们将要在操作系统上安装两个重要的工具软件。</p>
<p>第一个工具叫做CYGWIN，这是一个用于Windows平台上的Linux模拟器，它可以在你的电脑上创建一个模拟的Linux环境，只有这样才可以运行一些必须在Linux下运行的程序。听起来有点可怕，不过不用担心，其实很容易用的。</p>
<p>需要的第二个东西就时toolchain。这是PSP编程的关键，提供了你所需要的一切，包括头文件、库、编译器和一些例程。安装了这个之后，你就可以开始编写自己的第一个程序了。</p>
<p>现在开始介绍颇不急待想要了解的部分：开发环境的安装。</p>
<p>第一步就是安装CYGWIN。先在CYGWIN网站上下载CYGWIN的安装程序。</p>
<p>下载好之后，打开该可执行文件，会闪现一个安装界面；点击“next”按钮，此时你将可以看到有三个选项，选择默认选项“Install from Internet”，点击“next”；确定在那个目录下安装CYGWIN，如过不想将其安装在“C：/cygwin”处则更改之即可（C：是本地磁盘），其他选项设为默认，点击next；现在又提示让你确定“在哪里存放下载的安装文件”，这个选项无关紧要，不过最好将其放在一个自己可以找到的目录下，以便安装完之后删除。选定了合适的地方之后，点击next；下一屏会问你你的网络设置，如果你没有使用代理（或者不知道代理是甚么），直接点next。如果不行的话，返回上一步让他用IE浏览器的设置；然后，会提供一个下载安装文件的服务器列表，任何一个都可以，选择一个点击next；现在开始下载安装文件包列表，得几分钟时间，依赖于你的网速；下载完之后，拖动滑块，在“devel”哪里点击“default”使得它变成“install”。继续拖动滑块，将“Web”下面的“wget”设置为“install”。完成之后，点击next。CYGWIN将会被下载然后安装选择了的包。这个可能会用掉很长时间，所以等待的时候你可以看看电视或者浏览其他网页。完成CYGWIN安装之后，准备安装toolchain。</p>
<p>现在我们就可以在CYGWIN环境下安装toolchain了。为了建立开放环境，首先必须运行CYGWIN。从开始菜单或者“C：/cygwin”目录下，运行一个CYGWIN bash shell（cygwinbat）。会打开一个命令行，当可以看到“yourusername@yourcomputername~”，说明你的CYGWIN环境已经成功建立了，此时就可以关闭该窗口。</p>
<p>下载最新的toolchain（点击此处），在最上面就可以看见了，下载该文件。下载完成之后，使用winrar将其解压缩至“C：/cygwin/home/user”文件目录下，这里的“user”是你的用户名。现在就可以安装toolchain了。再次打开CYGWIN bash shell，现在是时候介绍一些Linux命令行了，在一行的开头有“$”这个符号，它意味着正在运行的shell是在用户模式下，和根（管理员）模式相对。这一点在CYGWIN中是很重要的，如果你不曾使用过Linux命令行的话，这一点也是要注意的。</p>
<p>现在需要改变目录至刚解压缩的toolchain目录下，在bash shell 中打“ls”，它代表list，会给出当前目录下所有文件的名称和其他信息（和Windows下的dir命令相似。现在就应该可以看见一个“psptoolchain”的文件夹，这就是我们所想要改变的目录。因此打“cd psptoolchain”然后按回车。CD代表改变文件目录（Change Directory），该命令会改变当前操作的目录。此刻打“ls”命令，就可以看见所有包含在“psptoolchain”目录下的文件。这里有一个我们将要用于创建所有东西的文件“toolchain.sh”。</p>
<p>由于toolchain的最近问题，我们必须更新所有的东西。因此更新和修改toolchain脚本，必须使用“svn update”然后回车。</p>
<p>结束之后输入“./toolchain.sh”执行更新后的脚步然后回车。在Linux下，“.”表示当前目录，而“..”表示父层目录。所以该命令表示执行在当前目录下的“toolchain.sh”脚本。Toolchain.sh脚步将会为你完成剩下的所有工作。这个会花掉近几个小时，依赖于你得机器配置。</p>
<p>漫长得等待终于结束了，现在可以进行最后一步了。必须告知CYGWIN在哪里可以找到PSPSDK（toolchain安装的）和toochian。为了实现上述目标，必须改变“C:/cygwin/cygwin.bat ”文件使它包含一些路径。关闭CYGWIN，然后使用资源管理器在“C:/cygwin”目录下右键点击“cygwin.bat”。选择“编辑”后弹出一个记事本窗口，显示的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">C:</div><div class="line">chdir C:/cygwinb/bin</div><div class="line">bash - -login –i</div></pre></td></tr></table></figure>
<p>将其改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">C:</div><div class="line">chdir C:/cygwinb/bin</div><div class="line">set path = %path%; C:/cygwin/usr/local/pspdev/bin</div><div class="line">set PSPSDK = C:/cygwin/usr/local/posdev</div><div class="line">bash - -login –i</div></pre></td></tr></table></figure>
<p>现在PSP游戏开放环境就建立好了。如果你现在有源代码的话就可以编译了，使用cd命令进入到源代码目录下，用make命令进行编译，就会生成一个eboot.pbp文件，该文件就可以直接放入你的PSP中运行。如果没有的话，可以通过下一节的学习来创建你自己的简单应用程序。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/04/03/OOAD/" itemprop="url">
                  面向对象分析和设计基本概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-04-03T19:57:00+08:00" content="2008-04-03">
              2008-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/软件工程/" itemprop="url" rel="index">
                    <span itemprop="name">软件工程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/04/03/OOAD/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/04/03/OOAD/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>面向对象是基于一种哲学思想，它认为：客观实体和实体之间的联系构成了现实世界的所有问题，而每一个实体都可以抽象为对象。这种思想尽可能地按照人类认识世界的方法和思维方式来分析和解决问题，使人们分析、设计一个系统的方法尽可能接近认识一个系统的方法。面向对象的基本观点可以概括如。（1）客观世界由对象组成，任何客观实体都是对象，复杂对象可以由简单对象组成。（2）具有相同数据和操作的对象可归纳成类，对象只是类的一个实例。（3）类可以派生出子类，子类除了继承父类的全部特性外还可以有自己的特性。（4）对象之间的联系通过消息传递来维系。由于类的封装性，它具有某些对外界不可见的数据，这些数据只能通过消息请求调用可见方法来访问。简单的来说，面向对象＝对象＋类＋继承＋消息。</p>
<p>面向对象分析（OOA）是指利用面向对象的概念和方法为软件需求建造模型，以使用户需求逐步精确化、一致化、完全化的分析过程。分析的过程也是提取需求的过程，主要包括理解、表达和验证。由于现实世界中的问题通常较为复杂，分析过程中的交流又具有随意性和非形式化等特点，软件需求规格说明的正确性、完整性和有效性就需要进一步验证，以便及时加以修正。面向对象分析中建造的模型主要有对象模型、动态模型和功能模型。其关键是识别出问题域中的对象，在分析它们之间相互关系之后建立起问题域的简洁、精确和可理解的模型。对象模型通常由五个层次组成：类与对象层、属性层、服务层、结构层和主题层，此五个层次对应着在面向对象分析过程中建立对象模型的五项主要活动：发现对象、定义类、定义属性、定义服务、设别结构。面向对象的分析过程如图1所示。</p>
<p><img src="/images/2008-04-03-1.bmp" alt="面向对象分析过程模型"></p>
<p>图1 面向对象分析过程模型</p>
<p>分析是提取和整理用户需求，并建立问题域精确模型的过程。面向对象设计（OOD）则是把分析阶段得到的需求转变成符合成本和质量要求的、抽象的系统实现方案的过程。从面向对象分析（OOA）到面向对象设计（OOD）是一个逐渐扩充模型的过程，也可以说面向对象设计是用面向对象观点建立求解域模型的过程。面向对象分析主要是模拟问题域和系统任务，而面向对象设计是面向对象分析的扩充，主要增加各种组成部分。面向对象设计的模型又五层组成，在设计期间主要扩充四个组成部分：人机交互部分、问题域、任务管理和数据管理。人机交互部分包括有效的人机交互所必须的实际显示和输入。问题域部分放置面向对象分析结果并管理面向对象分析的某些类和对象、结构、属性和方法。任务管理部分包括任务定义、通信和协调、硬件分配及外部系统。数据管理部分包括对永久性数据的访问和管理。面向对象设计模型如图2所示。</p>
<p><img src="/images/2008-04-03-2.bmp" alt="面向对象设计模型"></p>
<p>图2 面向对象设计模型</p>
<p>为了方便、高效地进行面向对象分析和设计，UML（Unified Modeling Language）被创造出来。UML是一种功能强大的、面向对象分析的可视化系统分析的建模语言，它采用一整套成熟的建模技术，广泛地适用于各个应用领域。运用UML进行面向对象分析设计，通常都要经过下述三个步骤。（1）识别系统的用例和角色。首先要对项目进行需求调研，分析项目的业务流程图和数据流程图，以及项目中涉及的各级操作人员，识别出系统中的所有用例和角色；接着分析系统中各角色和用例见的联系，使用UML建模工具画出系统的用例图；最后，勾画系统的概念层次模型，借助UML建模工具描述概念层的类和活动图。（2）进行系统分析并抽象出类。系统分析的任务是找出系统的所有要求并加以描述，同时建立特定领域模型。从实际需求抽象出类，并描述各个类之间的关系。（3）设计系统，并设计系统中的类及其行为。设计阶段由结构设计和详细设计组成。结构设计是高层设计，其任务是定义包（子系统）、包间的依赖关系和主要的通信机制。包有利于描述系统的逻辑组成以及各个部分之间的依赖关系。详细设计主要用来细化包的内容，清晰描述所有的类，同时使用UML的动态模型描述在特定环境下这些类的实例的行为。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/04/01/uml-usecase-diagram-intro/" itemprop="url">
                  用例图介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-04-01T00:00:00+08:00" content="2008-04-01">
              2008-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/软件工程/" itemprop="url" rel="index">
                    <span itemprop="name">软件工程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/04/01/uml-usecase-diagram-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/04/01/uml-usecase-diagram-intro/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="用例图"><a href="#用例图" class="headerlink" title="用例图"></a>用例图</h3><p>用例图(Use Case Diagram)是由软件需求分析到最终实现的第一步，它描述人们如何使用一个系统。用例视图显示谁是相关的用户、用户希望系统提供什么样的服务，以及用户需要为系统提供的服务，以便使系统的用户更容易理解这些元素的用途，也便于软件开发人员最终实现这些元素。用例图在各种开发活动中被广泛的应用，但是它最常用来描述系统及子系统。</p>
<p>当用例视图在外部用户出现以前出现时，它捕获到系统、子系统或类的行为。它将系统功能划分成对参与者（即系统的理想用户）有用的需求。而交互部分被称作用例。用例使用系统与一个或者多个参与者之间的一系列消息来描述系统中的交互。</p>
<p>用例图包含六个元素，分别是：参与者(Actor)、用例(Use Case)、关联关系(Association)、包含关系(Include)、扩展关系(Extend)以及泛化关系(Generalization)。</p>
<p>用例图可一个包含注释和约束，还可一个包含包，用于将模型中的元素组合成更大的模块。有时，可以将用例的实例引入到图中。用例图模型如下所示，参与者用人形图标来标识，用例用椭圆来表示，连线表示它们之间的关系。</p>
<p><img src="/images/2008-04-01-1.jpg" alt="用例图"></p>
<h4 id="1-参与者（Actor）"><a href="#1-参与者（Actor）" class="headerlink" title="1. 参与者（Actor）"></a>1. 参与者（Actor）</h4><h5 id="1-1-参与者的概念"><a href="#1-1-参与者的概念" class="headerlink" title="1.1 参与者的概念"></a>1.1 参与者的概念</h5><p>参与者是系统外部的一个实体，它以某种方式参与用例的执行过程。参与者通过向系统输入或请求系统输入某些事件来触发系统的执行。参与着由参与用例时所担当的角色来表示。在UML中，参与者用名字写在下面的人形图标表示。</p>
<p>每个参与者可以参与一个或多个用例。它通过交换信息与用例发生交互（因此也与用例所在的系统或类发生了交互），而参与者的内部实现与用例是不相关的，可以用一组定义其状态的属性充分的描述参与者。</p>
<p>参与者有三大类：系统用户、与所建造的系统交互的其它系统和一些可以运行的进程。</p>
<p>第一类参与者是真实的人，即用户，是最常见的参与者，几乎存在于每个系统中。命名这类参与者时，应当按照业务而不是位置命名，因为一个人可能有很多业务。</p>
<p>第二类参与者是其它的系统。这类位于程序边界之外的系统也是参与者。</p>
<p>第三类参与者是一些可以运行的进程，如时间。当经过一定的时间触发系统中的某个事件时，时间就成了参与者。</p>
<h5 id="1-2-确定参与者"><a href="#1-2-确定参与者" class="headerlink" title="1.2 确定参与者"></a>1.2 确定参与者</h5><p>在获取用例前首先要确定系统的参与者，开发人员可以通过回答以下的问题来寻找系统的参与者。</p>
<p>a. 谁将使用该系统的主要功能。<br>b. 谁将需要该系统的支持以完成其工作。<br>c. 谁将需要维护、管理该系统，以及保持该系统处于工作状态。<br>d. 系统需要处理哪些硬件设备。<br>e. 与该系统那个交互的是什么系统。<br>f. 谁或什么系统对本系统产生的结果感兴趣。</p>
<p>在对参与者建模的过程中，开发人员必须要牢记以下几点。</p>
<p>a. 参与者对于系统而言总是外部的，因此它们可以处于人的控制之外。<br>b. 参与者可以直接或间接的与系统交互，或使用系统提供的服务以完成某件事务。<br>c. 参与者表示人和事物与系统发生交户时所扮演的角色，而不是特定的人或者特定的事物。<br>d. 每个参与者需要一个具有业务一样的名字，在建模中不推荐使用类似“新参与者”的名字。<br>e. 每一个参与者要必须有简短的描述，从业务角度描述参与者是什么。<br>f. 一个人或事物在与系统发生交互时，可以同时或不同时扮演多个角色。<br>g. 和类一样，参与者可以具有表示参与者的属性和可以接受的事件，但使用的不频繁。</p>
<h5 id="1-3-参与者之间的关系"><a href="#1-3-参与者之间的关系" class="headerlink" title="1.3 参与者之间的关系"></a>1.3 参与者之间的关系</h5><p>因为参与者是类，所以多个参与者之间可以具有与类相同的关系。在用例视图中，使用了泛化关系来描述多个参与者之间的公共行为。如果系统中存在几个参与者，它们既扮演自身的角色 ，同时也扮演更具一般化的角色，那么就用泛化关系来描述它们。这种情况往往发生在一般角色的行为在参与者超类中描述的场合。特殊化的参与者继承了该超类的行为，然后在某些方面扩展了此行为。参与者之间的泛化关系用一个三角箭头来表示，指向扮演一般角色的超类。这与UML中类之间的返还关系符号相同。</p>
<p><img src="/images/2008-04-01-2.jpg" alt="用例图"></p>
<h4 id="2-用例（Use-Case）"><a href="#2-用例（Use-Case）" class="headerlink" title="2. 用例（Use Case）"></a>2. 用例（Use Case）</h4><h5 id="2-1-用例的概念"><a href="#2-1-用例的概念" class="headerlink" title="2.1 用例的概念"></a>2.1 用例的概念</h5><p>用例是外部可见的系统功能单元，这些系统功能由系统单元所提供，并通过一系列系统单元与一个或多个参与者之间交换的消息所表达。用例的用途是，在不揭示系统内部构造的前提下定义连贯的行为。</p>
<p>用例的定义包含它所必须的所有行为——执行用例的主线次序、标准行为的不同变形、一般行为下的所有异常情况及其预期反应。从用户的角度来看，上述情况很可能是异常情况；从系统的角度来看，它们是必须被描述和处理的附加情况。更确切地说，用例不是需求或功能的规格说明，但是也展示和体现其所描述的过程中的需求情况。在UML中，用例用一个椭圆表示。</p>
<p>在模型中，每个用例的执行都独立与其它用例，尽管在执行一个用例时由于用例之间共享对象的原因可能会在用例之间产生隐含的依赖关系。每个用例都表示一个纵向的功能块，这个功能块的执行会和其它用例的执行混合在一起。</p>
<p>用例的动态执行过程可以用UML的交互来说明，可用用状态图、时序图、协作图或非正式的文字描述来表示。用例功能的执行通过系统中类之间的协作来实现。一个类可以参与多个协作，因此也参与了多个用例。</p>
<p>在系统层，用例表示整个系统对外部用户可见的行为。一个用例就像外部用户可以使用的系统操作。但是，它不又与操作不同，用例可以在执行过程中持续接受参与者的输入消息。用例也可以被像子系统和独立类这样的系统小单元所应用。一个内部用例表示了系统的一部分对其它部分呈现出的行为。例如，某个类的用例表示了一个连贯的功能块，这个功能块是该类提供给系统内其它有特定作用的类的。一个类可以有多个用例。</p>
<h5 id="2-2-识别用例"><a href="#2-2-识别用例" class="headerlink" title="2.2 识别用例"></a>2.2 识别用例</h5><p>用例图对整个系统建模过程非常重要，在绘制系统用例图前，还有许多工作要做。系统分析者必须分析系统的参与者和用例，他们分别描述了“谁来做”和“做什么”这两个问题。</p>
<p>识别用例最好的方法就是从分析系统的参与者开始，考虑每一个参与者是如何使用系统的。使用这种策略的过程中可能会发现新的参与者，这对完善整个系统的建模有很大的帮助。用例建模的过程是一个迭代和逐步精华的过程，系统分析者首先从用例的名称开始，然后添加用例的细节信息。这些信息由简短的描述组成，它们被精华成完整的规格说明。</p>
<p>在识别用例的过程中，通过回答以下几个问题，系统分析者可以获得帮助。</p>
<p>a. 特定参与者希望系统提供什么功能。<br>b. 系统是否存储和检索信息，如果是，由哪个参与者触发。<br>c. 当系统改变状态时，是否通知参与者。<br>d. 是否存在影响系统的外部事件。<br>e. 哪个参与者通知系统这些事件。</p>
<h5 id="2-3-用例与事件流"><a href="#2-3-用例与事件流" class="headerlink" title="2.3 用例与事件流"></a>2.3 用例与事件流</h5><p>用例分析处于系统的需求分析阶段，这个阶段应该尽量避免考虑系统实现的细节问题。但是要实际建立系统，则需要更加具体的细节，这些细节写在事件流文件中。事件流的目的是为用例的逻辑流程建立文档，这个文档详细描述系统用户的工作和系统本身的工作。</p>
<p>虽说事件流很详细，但其仍然是独立于实现的方法的。换句话说，事件流描述的是一个系统“做什么”而不是“怎么做”。事件流通常包括：简要说明、前提条件、主事件流、其它事件流和事后事件流。</p>
<p>a. 简要说明。<br>    每个用例应当有一个相关的说明，描述该用例的作用，说明应当简明扼要，但应包括执行用例的不同类型的用户和通过这个用例要达到的结果。<br>b. 前提条件。<br>    用例的前提条件列出用例之间必须满足的条件。例如，前提条件是另一个用例已经执行或用户具有运行当前用例的权限。但并不是所有用例都有前提条件。<br>c. 主事件流和其它事件流。<br>    用例的具体细节在主事件流和其它事件流中描述。事件流是从用户角度描述执行用例的具体步骤，关注系统“做什么”，而不是“怎么做”。主事件流和其它事件流包括：用例如何开始和结束、用例如何与参与者交互、用例的正常流程（主流程）、用例主事件流（其它事件流）的变体和错误流。<br>d. 事后条件。<br>    事后条件是用例执行完毕后必须为真的条件。例如，可以在用例完成之后设置一个标识，这种信息就是事后条件。与前提条件一样，事后条件可以增加用例次序方面的信息，如果要求一个用例执行完后必须执行另一个用，那么就可以在事后条件中说明这一点。当然，并不是每个用例中都有事后条件。</p>
<h4 id="3-用例间的关系"><a href="#3-用例间的关系" class="headerlink" title="3. 用例间的关系"></a>3. 用例间的关系</h4><p> 用例除了与参与者发生关系外，还可以具有系统中的多个关系，这些关系包括包含关系、扩展关系和泛化关系。应用这些关系的目的是为了从系统中抽取出公共行为和其变体。</p>
<h5 id="3-1-关联关系（Association）"><a href="#3-1-关联关系（Association）" class="headerlink" title="3.1 关联关系（Association）"></a>3.1 关联关系（Association）</h5><p> 关联关系描述参与者与用例之间的关系，它是用于表示类的挂系的关联元类的实例。在UML中，关联关系用箭头来表示。</p>
<p> 关联关系表示参与者与用例之间的通信。不同的参与者可以访问相同的用例，一般说来它们和该用例的交互是不一样的，如果一样的话，说明它们的角色可能是相同的。如果两中交互的目的也相同，说明它们的角色是相同的，就可以将它们合并。</p>
<p> <img src="/images/2008-04-01-4.jpg" alt="用例图"></p>
<h5 id="3-2-包含关系（Include）"><a href="#3-2-包含关系（Include）" class="headerlink" title="3.2 包含关系（Include）"></a>3.2 包含关系（Include）</h5><p>虽然每个用例的实例都是独立的，但是一个用例可以用其它的更简单的用例来描述。这有点像通过继承父类并增加附加描述来定义一个类。一个用例可以简单地包含其它用例具有的行为，并把它所包含的用例行为作为自身行为的一部分，这被称作包含关系。在这种情况下，新用例不是初始用例的一个特殊例子，并且不能被初始用例所代替。爱UML中，包含关系表示为虚线箭头交&lt;<include>&gt;字样，箭头指向被包含的用例。</include></p>
<p>包含关系把几个用例的公共步骤分离成一个单独的被包含用例。被包含用例称作提供者用例，包含用例称作客户用例，提供者用例提供功能给客户使用。用例间的包含关系允许包含提供者用例的行为到客户用例的事件中。</p>
<p>包含关系使一个用例的功能可以在另一个用例中使用，如下所述。</p>
<p>a. 如果两个以上用例有大量一致的功能，则可以将这个功能分解到另外一个用例中。其它用例可以和这两个用例建立包含关系。<br>b. 一个用例的功能太多时，可以用包含关系建模两个小用例。<br>    要使用包含关系，就必须在客户用例中说明提供者用例行为别包含的详细位置。这一点同功能调用有点类似。事实上，它们在某种程度上具有相似的语义。</p>
<p><img src="/images/2008-04-01-5.jpg" alt="用例图"></p>
<h5 id="3-3-扩展关系（Extend）"><a href="#3-3-扩展关系（Extend）" class="headerlink" title="3.3 扩展关系（Extend）"></a>3.3 扩展关系（Extend）</h5><p>一个用例也可以被定义为基础用例的增量扩展，这被称作扩展关系，扩展关系是把新的行为插入到已有的用例中的方法。同一个基础用例的几个扩展用例可以在一起应用。基础用例的扩展增加了原有的语义，此时基础用例而不是扩展用例被作为例子使用。在UML中，扩展关系表示为虚线箭头加&lt;<extend>&gt;字样，箭头指向被扩展展的用例。</extend></p>
<p>基础用例提供了一组扩展点，在这些新的扩展点中可以添加新的行为，而扩展用例提供了一组插入片片段，这些片段能够被插入到基础用例的扩展点上。基础用例不必知道扩展用例的任何细节，它仅为其提供扩展点。事实上，基础用例即使没有扩展用例也是完整的，这点与包含关系有所不同。一个用例可能有多个扩展点，每个扩展点可以出现多次。但是一般情况下，基础用例的执行不和涉及到扩展用例，只有特定的条件发生，扩展用例才被执行。扩展关系为处理异常或构建灵活的系统框架提供了一种有效的方法。</p>
<p><img src="/images/2008-04-01-6.jpg" alt="用例图"></p>
<h5 id="3-4-泛化关系（Generalization）"><a href="#3-4-泛化关系（Generalization）" class="headerlink" title="3.4 泛化关系（Generalization）"></a>3.4 泛化关系（Generalization）</h5><p>一个用例可以被特别列举为一个或多个用例，这被称为用例泛化。当父用例能够被使用时，任何子用例也可以被使用。在UML中用例泛化与其它泛化关系的表示法相同，用一个三角箭头从子用例指向父用例。</p>
<p>在用例泛化中，子用例表示父用例的特殊形式。子用例从父用例处继承行为和属性，还可以添加、覆盖或改变继承的行为。如果系统中一个或多个用例是某个一般用例的特殊化时，就需要使用用例的泛化关系。</p>
<p><img src="/images/2008-04-01-7.jpg" alt="用例图"></p>
<h3 id="用例建模技术"><a href="#用例建模技术" class="headerlink" title="用例建模技术"></a>用例建模技术</h3><h4 id="1-对语境建模"><a href="#1-对语境建模" class="headerlink" title="1. 对语境建模"></a>1. 对语境建模</h4><p>对于一个系统，会有一些事物存在于其内部，而一些事物存在于其外部。存在于系统内部的事物的任务是完成系统外部事物所期望的系统行为，存在于系统外部并与其进行交互的事物构成了系统的语境，即系统存在的环境。在UML建模中，用例图对系统的语境进行建模，强调的是系统的外部参与者。对系统语境建模应当遵循以下的方法：</p>
<p>a. 用以下几组事物来识别系统外部的参与者：需要从系统中得到帮助以完成其任务的组；执行系统功能时所必须的组；与外部硬件或其它软件系统进行交互的组；为了管理和维护而执行某些辅助功能的组。<br>b. 将类似的参与者组织成泛化/特殊化的结构层次。<br>c. 在需要加深理解的地方，为每个参与者提供一个构造型。<br>d. 将参与者放入到用例图中，并说明参与者与用例之间的通信路径。</p>
<h4 id="2-对需求建模"><a href="#2-对需求建模" class="headerlink" title="2. 对需求建模"></a>2. 对需求建模</h4><p>需求就是根据用户对产品功能的期望，提出产品外部功能的描述。需要分析所要做的工作是获取系统的需求，归纳系统所要实现的功能，使最终的软件产品最大限度的贴近用户的要求。对系统需求建模可以参考以下的方法。</p>
<p>a. 识别系统外部的参与者来建立系统的语境。<br>b. 考虑每一个参与者期望的行为或需要系统提供的行为。<br>c. 把公共的行为命名为用例<br>d. 分解公共行为，放入到新的用例中以供其它的用例使用：分解异常行为，放入新用例中以延伸为主要的控制流。简而言之，就是确定提供者用例和扩展用例。<br>e. 在用例视图中对用例、参与者和它们之间的关系进行建模。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/03/19/chromaticityy-diagram/" itemprop="url">
                  色度图
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-03-19T12:20:00+08:00" content="2008-03-19">
              2008-03-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/03/19/chromaticityy-diagram/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/03/19/chromaticityy-diagram/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>“色度图”在学术文献中的解释</p>
<ol>
<li>黑体轨迹的函数表达式v＝f（u）在色度学中以色度坐标表示的平面图称为色度图.而黑体不同温度的光色变化在色度图上又形成了一个弧形轨迹这个轨迹叫做普朗克轨迹或黑体轨迹。</li>
<li>以色度坐标表示的平面图称为色度图.3．2色度学系统的应用随着人们交流、传输、研究颜色信息的需要已经建立了多种各具特色的表色系统本研究采用了CIE1931标准色度学系统和CIE1976（L＊a＊b＊）均匀色空间。</li>
</ol>
<p><img src="/images/2008-03-19-chromaticityy-diagram.jpg" alt="色度图"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/03/11/windows-message-cycle/" itemprop="url">
                  应用程序的消息循环
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-03-11T00:00:00+08:00" content="2008-03-11">
              2008-03-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/03/11/windows-message-cycle/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/03/11/windows-message-cycle/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Windows是消息驱动的，它的消息循环部分主要是通过GetMessage函数来处理消息的。操作系统为每一个创建的窗口维护着一个消息队列，当在该窗口上有事件发生时，操作系统就把该事件所对应的消息放入该窗口的消息队列中。应用程序要处理事件消息的话，就必须先将消息取出来，主要有两个函数可以实现：GetMessage和PeekMessage。</p>
<p>它们两者的功能有所不同：当消息队列中没有消息的时候GetMessage会挂起，将CPU资源让给其他应用程序，当有消息可以处理时，才获得CPU资源并处理。而PeekMessage则不管消息队列有无消息立即返回。</p>
<p>一般情况下，GetMessage可以在非FPS（Frame Per Second）应用程序中高效运行。但是当它在FPS（如：游戏）应用中运行时，有时回出现闪屏。故在FPS程序中最好还是用PeekMessage函数。</p>
<p>其用法如下：</p>
<ul>
<li><strong>GetMessage</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// 主消息循环:</div><div class="line">while (GetMessage(&amp;msg, NULL, 0, 0)) </div><div class="line">&#123;</div><div class="line">      if (!TranslateAccelerator(msg.hwnd, hAccelTable, &amp;msg)) </div><div class="line">      &#123;</div><div class="line">             TranslateMessage(&amp;msg);</div><div class="line">             DispatchMessage(&amp;msg);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>PeekMessage</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// 主消息循环:</div><div class="line">ZeroMemory(&amp;msg,sizeof(MSG));</div><div class="line">while (msg.message != WM_QUIT) </div><div class="line">&#123;</div><div class="line">     if(PeekMessage(&amp;msg, NULL, 0, 0, PM_REMOVE))</div><div class="line">            &#123;</div><div class="line">            if (!TranslateAccelerator(msg.hwnd, hAccelTable, &amp;msg)) </div><div class="line">            &#123;</div><div class="line">                   TranslateMessage(&amp;msg);</div><div class="line">                   DispatchMessage(&amp;msg);</div><div class="line">            &#125;</div><div class="line">     &#125;</div><div class="line">     if(!DoFrame()) // 帧处理</div><div class="line">            break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/02/29/windows-dll/" itemprop="url">
                  Windows动态链接库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-02-29T00:00:00+08:00" content="2008-02-29">
              2008-02-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/02/29/windows-dll/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/02/29/windows-dll/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>动态链接库为模块化应用程序提供了一种方式，使得更新和重用程序更加方便。当几个应用程序在同一时间使用相同的函数时，它也帮助减少内存消耗，这是因为虽然每个应用程序有独立的数据拷贝，但是它们的代码却是共享的。</p>
<h3 id="动态连接库的概念"><a href="#动态连接库的概念" class="headerlink" title="动态连接库的概念"></a>动态连接库的概念</h3><p>动态链接库是应用程序的一个模块，这个模块用于到处一些函数和数据供程序中的其他模块使用。应该从以下三个方面来理解：</p>
<ol>
<li>动态连接库是应用程序的一部分，它的任何操作大都是代表应用程序进行的。所以动态链接库文件和可执行文件在本质上来说是一样的，都是作为模块被进程加载到自己的空间地址的。</li>
<li>动态链接库在程序在编译时不会被插入到可执行文件中，在程序运行时整个库的代码才会调入内存，这就是所谓的“动态链接”。</li>
<li>如果多个程序用到同一个动态链接库，Windows在物理内存中只保留一份库的代码，仅通过分页机制将这份代码映射到不同的进程中。这样不管有多少个程序同时使用一个库，库代码实际占用的物理内存永远只有一份。</li>
</ol>
<p>动态链接库（Dynamic Link Library）的缩写为DLL，大部分动态链接库镜像文件的扩展名为dll，但扩展名为其他的文件也有可能是动态链接库，如系统中的某些exe文件，各种控件（ocx）等都是动态链接库</p>
<h3 id="动态链接库的入口点函数"><a href="#动态链接库的入口点函数" class="headerlink" title="动态链接库的入口点函数"></a>动态链接库的入口点函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">BOOL APIENTRY DllMain( HANDLE hModule,</div><div class="line">                       DWORD ul_reason_for_call,</div><div class="line">                       LPVOID lpReserved</div><div class="line">                                    )</div><div class="line">&#123;</div><div class="line">    switch (ul_reason_for_call)</div><div class="line">       &#123;</div><div class="line">              case DLL_PROCESS_ATTACH:</div><div class="line">              case DLL_THREAD_ATTACH:</div><div class="line">              case DLL_THREAD_DETACH:</div><div class="line">              case DLL_PROCESS_DETACH:</div><div class="line">                     break;</div><div class="line">    &#125;</div><div class="line">    return TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>hModule</strong><br>    参数是本DLL模块的句柄，即本动态链接库模块的实例句柄，数值上是这个文件的映像加载到进程的地址空间时使用的基地址。需要注意的是，在动态链接库中通过“GetModuleHandle(NULL)”语句得到的是主模块（可执行文件的映像）的基地址，而不是DLL文件的基地址。</p>
<p><strong>ul_reason_for_call</strong><br>    参数表示本次调用的原因，可能是下4中情况的一种：</p>
<pre><code>1. DLL_PROCESS_ATTACH      表示动态链接库刚被某个进程加载，程序可以在这里做一些初始化工作，并返回TRUE表示初始化成功，返回FALSE表示初始化出错，这样库的装载就会失败。这给动态链接库一个机会来阻止自己被装入。
2. DLL_PROCESS_DETACH      此时相反，表示动态链接库将被卸载，程序可以在这里进行一些资源的释放工作。
3. DLL_THREAD_ATTACH表示应用程序创建了一个线程。
4. DLL_THREAD_DETACH       表示某个线程正常终止了。
</code></pre><h3 id="动态链接库中的函数"><a href="#动态链接库中的函数" class="headerlink" title="动态链接库中的函数"></a>动态链接库中的函数</h3><p>DLL能够定义两种函数，导出函数和内部函数。导出函数可以被其他模块调用，也可以被定这个模块调用，而内部函数只能被定义这个函数的模块调用。</p>
<p>动态链接库的主要功能是向外导出函数，供进程中其他模块使用。动态链接库中代码的编写也没什么特别之处，还要包含文件还可以使用资源，C++类等。</p>
<p>动态链接库工程编译后，在工程的Debug或者Release目录下会生成两个个有用的文件，.dll文件就是动态链接库，.lib文件是供程序开发用的导入库，.h文件包含了导出函数的声明。</p>
<h3 id="导出函数的使用"><a href="#导出函数的使用" class="headerlink" title="导出函数的使用"></a>导出函数的使用</h3><p>调用DLL中的导出函数有两种方法：</p>
<p><strong>第一种. 装载期间动态链接。</strong></p>
<p>模块可以像调用本地函数一样调用从其他模块导出的函数（API函数就是这样用的）。装载期间链接必须使用DLL的导入库（.lib文件），它为系统提供了加载这个DLL和定位这个DLL中的导出函数所需的所有信息。</p>
<p>所谓装载期间链接，就是应用程序启动时由加载器（加载应用程序的组件）载入dll。载入器如何知道要载入哪些DLL呢？这些信息记录在可执行文件（PE文件）的idata节中。使用这种方法不用自己写代码显式的加载DLL。在程序只需：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#include “ xxx.h”</div><div class="line">#pragma comment(lib,”xxx”)</div></pre></td></tr></table></figure>
<p>或者直接将xxx.lib文件添加到工程中，效果是一样的。</p>
<p><strong>注意：</strong></p>
<ol>
<li>发布软件时必须将该软件使用的DLL与程序一起发布。载入器在加载DLL文件时，默认情况是在应用程序的当前目录下查找，如果找不到就会到系统盘“/windows/system32”文件夹下查找，如果还是找不到就安错误处理。这种方法加载DLL库的缺点很明显，如果用户丢失了DLL文件，那么程序永远也不能启动了。所以很多时候要采取运行期间动态链接的方法。</li>
<li>运行期间动态链接。模块也可以使用LoadLibray或者LoadLibrayEx函数在运行期间加载这个DLL。DLL被加载之后，加载模块调用GetProcAddress函数获得DLL导出函数的地址，然后通过函数地址调用DLL中的函数。</li>
</ol>
<p><strong>第二种. 运行期间动态链接是在程序运行过程中显示地去加载DLL库，从中导出所需的函数。</strong></p>
<p>为了能够运行期动态的导出函数，一般需要在工程中建立一个DEF文件来指定要导出的函数。在新添的.def文件中写入如下内容：</p>
<pre><code>EXPORTS              
 xxxFunction
</code></pre><p>这两行说明此DLL库要向外导出xxxFunction函数。</p>
<p>调用DLL导出函数时分两步进行。</p>
<p>1&gt;. 加载目标DLL，如下代码：</p>
<pre><code>HMODULE hModule=LoadLibrary(“xxx.dll”);
</code></pre><p>LoadLibrary函数的作用是加载指定目录下的DLL库到进程的虚拟地址空间，函数执行成功返回此DLL模块的句柄，否则返回NULL。事实上，载入器也是调用这个函数加载DLL的。在不使用DLL模块时，应该调用FreeLibrary函数释放它所占的资源。</p>
<p>2&gt;. 取得目标DLL中导出函数的地址，这项工作由GetProcAddress函数来完成。</p>
<pre><code>FARPROC GetProcAddress(
     HMODULE hModule, // 函数所在模块的模块句柄
     LPCSTR lpProcName // 函数的名称
)
</code></pre><p>函数执行成功返会函数的地址，失败返回NULL。</p>
<p>在使用方法一时，三个文件都会被用到，使用第二种方法时，只有.dll文件会被用到。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li><strong>生成DLL</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">// DllTest.cpp : Defines the entry point for the DLL application.</div><div class="line">// 生成DLL文件，.def文件用于运行期间动态链接，若为静态则不需该文件</div><div class="line"></div><div class="line">#include &quot;stdafx.h&quot;</div><div class="line">#include &quot;DllTest.h&quot;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line"></div><div class="line">HMODULE g_hModule;</div><div class="line"></div><div class="line">BOOL APIENTRY DllMain( HANDLE hModule, </div><div class="line">                       DWORD  ul_reason_for_call, </div><div class="line">                       LPVOID lpReserved</div><div class="line">                     )</div><div class="line">&#123;</div><div class="line">    switch(ul_reason_for_call)</div><div class="line">    &#123;</div><div class="line">    case DLL_PROCESS_ATTACH:   // 刚被某个进程加载</div><div class="line">        g_hModule = (HMODULE) hModule;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    return TRUE;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">// 自定义导出函数</div><div class="line"></div><div class="line">void DllTest1(LPCSTR pszContent)</div><div class="line">&#123;</div><div class="line">    char sz[MAX_PATH];</div><div class="line">    ::GetModuleFileName(g_hModule,sz,MAX_PATH);</div><div class="line">    MessageBox(NULL,pszContent,strrchr(sz,&apos;/&apos;)+1,MB_OK);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void DllTest2()</div><div class="line">&#123;</div><div class="line">    DllTest1(&quot;Hello world!  Hello Dll files!&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// DllTest.h</div><div class="line">// The following ifdef block is the standard way of creating macros which make exporting </div><div class="line">// from a DLL simpler. All files within this DLL are compiled with the DLLTEST_EXPORTS</div><div class="line">// symbol defined on the command line. this symbol should not be defined on any project</div><div class="line">// that uses this DLL. This way any other project whose source files include this file see </div><div class="line">// DLLTEST_API functions as being imported from a DLL, wheras this DLL sees symbols</div><div class="line">// defined with this macro as being exported.</div><div class="line">#ifdef DLLTEST_EXPORTS</div><div class="line">#define DLLTEST_API __declspec(dllexport)</div><div class="line">#else</div><div class="line">#define DLLTEST_API __declspec(dllimport)</div><div class="line">#endif</div><div class="line"></div><div class="line">// 声明要导出的函数</div><div class="line">DLLTEST_API void DllTest1(LPCSTR pszContent);</div><div class="line">DLLTEST_API void DllTest2();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// DllTest.def</div><div class="line">EXPORTS</div><div class="line"> DllTest1</div><div class="line"> DllTest2</div></pre></td></tr></table></figure>
<ul>
<li><strong>使用Dll动态链接库</strong> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// DllUse1.cpp : Defines the entry point for the console application.</div><div class="line">// 装载期间动态链接</div><div class="line"></div><div class="line">#include &quot;stdafx.h&quot;</div><div class="line">#include &quot;DllTest.h&quot;</div><div class="line">#pragma comment(lib,&quot;DllTest&quot;)</div><div class="line"></div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    DllTest2();</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// DllUse2.cpp : Defines the entry point for the console application.</div><div class="line">// 运行期间动态链接</div><div class="line"></div><div class="line">#include &quot;stdafx.h&quot;</div><div class="line">#include &lt;windows.h&gt;</div><div class="line"></div><div class="line">typedef void(*PFNDLLTEST2)(void);</div><div class="line"></div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    // 加载DLL</div><div class="line">    HMODULE hModule = LoadLibrary(&quot;DllTest.dll&quot;);</div><div class="line">    if(hModule != NULL)</div><div class="line">    &#123;</div><div class="line">        // 取得DllTest的导出函数的地址</div><div class="line">        PFNDLLTEST2 mDllTest2 = (PFNDLLTEST2)GetProcAddress(hModule, &quot;DllTest2&quot;);</div><div class="line">        if(mDllTest2 != NULL)</div><div class="line">        &#123;    </div><div class="line">            mDllTest2();</div><div class="line">        &#125;</div><div class="line">        // 卸载DLL</div><div class="line">        FreeLibrary(hModule);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/02/28/windows-hook/" itemprop="url">
                  Windows钩子
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-02-28T00:00:00+08:00" content="2008-02-28">
              2008-02-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Windows/" itemprop="url" rel="index">
                    <span itemprop="name">Windows</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/02/28/windows-hook/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/02/28/windows-hook/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Windows应用程序的运行模式是基于消息驱动的，任何线程只要注册了窗口类就会有一个消息队列来接收用户的输入消息和系统消息。为了取得特定线程接收或发送的消息，就要 Windows提供的钩子。</p>
<h3 id="钩子的概念"><a href="#钩子的概念" class="headerlink" title="钩子的概念"></a>钩子的概念</h3><p>钩子（Hook）是Windows消息处理机制中的一个监视点，应用程序可以在这里安装一个子程序（钩子函数）以监视指定窗口某种类型的消息，所监视的窗口可以是其他进程创建的。当消息到达后，在目标窗口处理函数处理之前，钩子机制允许应用程序截获它进行处理。</p>
<p>钩子函数是一个处理消息的程序段，通过调用相关的API函数，把它挂入系统。每当特定的消息发出，在没有到达目的窗口前，钩子程序就捕获该消息，亦即钩子函数先得到控制权。这时钩子函数即可以加工处理（改变）该消息，也可以不作处理而继续传递该消息。</p>
<p>总之，关于Windows钩子要知道以下几点：</p>
<ol>
<li>钩子是用截获系统中的消息流。利用钩子，可以处理任何感兴趣的消息，包括其他进程的消息。</li>
<li>截获消息后，用于处理消息的子程序叫做钩子函数，它是应用程序自定义的一个函数，在安装钩子时要把这个函数的地址告诉Windows。</li>
<li>系统中同一时间可能有多个进程安装了钩子，多个钩子函数在一起组成钩子链。所以在处理截获到的消息时，应该把消息事件传递下去，以便其他钩子也有机会处理这一消息。</li>
</ol>
<p>钩子会使得系统变慢，因为它增加了系统对每个消息的处理量。仅应该在必要时才安装钩子，而且在不需要时应尽快移除。</p>
<h3 id="钩子的安装"><a href="#钩子的安装" class="headerlink" title="钩子的安装"></a>钩子的安装</h3><p>SetWindowsHookEx函数可以把应用程序定义的钩子函数安装到系统中。</p>
<pre><code>HHOOK SetWindowsHookEx(
    Int idHook ;       // 指定钩子的类型
    HOOKPROC lpfn;   // 钩子函数的地址。如果使用的是远程钩子，钩子函数必须放在一个DLL中。
    HINSTANCE hMod; // 钩子函数所在DLL的实例句柄。如果是一个局部的钩子，该参数为NULL。
    DWORD    dwThreadID; // 指定要为哪个线程安装钩子。若该值为0被解释成系统范围内的。
）
</code></pre><p>IdHook参数指定了要安装的钩子的类型，可以是下列取值之一：</p>
<pre><code>WH_CALLWNDPROC       当目标线程调用SendMessage函数发送消息时，钩子函数被调用。
WH_CALLWNDPROCRET                   当SendMessage发送的消息返回时，钩子函数被调用。
WH_GETMESSAGE           当目标线程调用GetMessage或者PeekMessage时。
WH_KEYBOARD               当从消息队列中查询WM_KEYUP或WM_KEYDOWN消息时
WH_MOUSE                       当调用从消息队列中查询鼠标事件消息时
WH_MSGFILTER               当对话框，菜单或滚动条要处理一个消息时，钩子函数被调用。该钩子是局部的，它是为哪些有自己消息处理过程的控件对象设计的。
WH_SYSMSGFILTER        和WH_MSGFILTER一样，只不过是系统范围的。
WH_JOURNALRECORD 当Windows从硬件队列中获取消息时。
WH_JOURNALPLAYBACK       当一个事件从系统的硬件输入队列中别请求时
WH_SHELL                         当关于Windows外壳事件发生时，比如任务条需要重画它的按钮
WH_CBT                             当基于计算机的训练（CBT）事件发生时。
WH_FOREGROUNDIDLE Windows自己使用，一般应用程序很少使用。
WH_DEBUG                       用来给钩子函数除错。
</code></pre><p>Lpfn参数是钩子函数的地址。钩子安装后如果有消息发生，Windows将调用此参数所指向的函数。</p>
<p>如果dwThreadId参数是0，或者指定一个由其他进程创建的线程ID，lpfn参数指向的钩子函数必须位于一个DLL中。这是因为进程的地址空间是相互隔离的，发生事件的进程不能调用其他进程地址空间的钩子函数。如果钩子函数的实现代码在DLL中，在相关事件发生时，系统会把这个DLL插入到发生事件的进程的地址空间，使它能够调用钩子函数。这种需要将钩子函数写入DLL以便挂钩其他进程事件的钩子称为远程钩子。</p>
<p>如果dwThreadId参数指定一个由自身进程创建的线程ID，lpfn参数指向的钩子函数只要在当前进程中即可，不必非要写入DLL。这种挂钩属于自身进程事件的钩子称为局部钩子。</p>
<p>hMod参数是钩子函数所在DLL的实例句柄，如果钩子函数不再DLL中，应将hMod设置为NULL。</p>
<p>dwThreadId参数指定要与钩子函数相关联的线程ID号。如果设为0，那么钩子就是系统范围内的，即钩子函数将关联到系统内所有线程。</p>
<h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><p>钩子安装后如果有相应的消息发生，Windows将调用SetWindowsHookEx函数指定的钩子函数lpfn。钩子函数的一般形式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">LRESULT CALLBACK <span class="title">HookProc</span><span class="params">(<span class="keyword">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 处理该消息的代码 …..</span></div><div class="line"> </div><div class="line">    Return ::CallNextHookEx(hHook,nCode,wParam,lParam);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HookProc是应用程序的名称。nCode参数是Hook代码，钩子函数使用这个参数来确定任务，它的值依赖于Hook的类型。wParam和lParam参数的值依赖于Hook代码，但是它们典型的值是一些关于发送或者接收消息的信息。</p>
<p>因为系统中可能会有多个钩子的存在，所以要调用那个CallNextHookEx函数把消息传到链中下一个钩子函数。hHook参数是安装钩子时得到的钩子句柄（SetWindowsHookEx的返回值）。</p>
<h3 id="卸载钩子"><a href="#卸载钩子" class="headerlink" title="卸载钩子"></a>卸载钩子</h3><p>要卸载钩子，可以调用UnhookWindowsHookEx函数。</p>
<pre><code>BOOL UnhookWindowsHookEx(HHOOK hhk); // hhk 为要卸载的钩子的句柄
</code></pre><p>注意：</p>
<ul>
<li>安装钩子的代码可以在DLL模块中，也可以在主模块中，但是一般在DLL里实现它，主要是为了使程序更加模块化。</li>
</ul>
<h3 id="例子（HOOK键盘消息）"><a href="#例子（HOOK键盘消息）" class="headerlink" title="例子（HOOK键盘消息）"></a>例子（HOOK键盘消息）</h3><ul>
<li><strong>dll库的生成（只是部分重要的文件，没有全部贴出）</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ke </span></div><div class="line"><span class="comment">//The following ifdef block is the standard way of creating macros which make exporting </span></div><div class="line"><span class="comment">// from a DLL simpler. All files within this DLL are compiled with the KEYHOOKLIB_EXPORTS</span></div><div class="line"><span class="comment">// symbol defined on the command line. this symbol should not be defined on any project</span></div><div class="line"><span class="comment">// that uses this DLL. This way any other project whose source files include this file see </span></div><div class="line"><span class="comment">// KEYHOOKLIB_API functions as being imported from a DLL, wheras this DLL sees symbols</span></div><div class="line"><span class="comment">// defined with this macro as being exported.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> KEYHOOKLIB_EXPORTS</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYHOOKLIB_API __declspec(dllexport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KEYHOOKLIB_API __declspec(dllimport)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 自定义与主程序通信的消息</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HM_KEY WM_USER+1</span></div><div class="line"></div><div class="line"><span class="comment">// 声明要导出的函数</span></div><div class="line"><span class="function">BOOL KEYHOOKLIB_API WINAPI <span class="title">SetKeyHook</span><span class="params">(BOOL bInstall, </span></span></div><div class="line">                               DWORD dwThreadId = <span class="number">0</span>, </div><div class="line">                               HWND hWndCaller = <span class="literal">NULL</span></div><div class="line">                               );</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// KeyHookLib.cpp : Defines the entry point for the DLL application.</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"KeyHookLib.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">// 共享数据段</span></div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg(<span class="meta-string">"YCIShared"</span>)</span></div><div class="line">HWND g_hWndCaller = <span class="literal">NULL</span>;</div><div class="line">HHOOK g_hHook = <span class="literal">NULL</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg()</span></div><div class="line"></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyHookProc</span><span class="params">(<span class="keyword">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 一个通过内存地址取得模块句柄的帮助函数。</span></div><div class="line"><span class="function">HMODULE    WINAPI <span class="title">ModuleFromAddress</span><span class="params">(PVOID pv)</span></span></div><div class="line">&#123;</div><div class="line">    MEMORY_BASIC_INFORMATION mbi;</div><div class="line">    <span class="keyword">if</span>(VirtualQuery(pv,&amp;mbi,<span class="keyword">sizeof</span>(mbi)) != <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> (HMODULE)mbi.AllocationBase;</div><div class="line">    &#125;<span class="keyword">else</span> </div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 安装钩子，卸载钩子的函数</span></div><div class="line"><span class="function">BOOL WINAPI <span class="title">SetKeyHook</span><span class="params">(</span></span></div><div class="line">            BOOL bInstall,         <span class="comment">// 安装还是卸载已安装的钩子</span></div><div class="line">            DWORD dwThreadId,      <span class="comment">// 目标线程的ID</span></div><div class="line">            HWND  hWndCaller)      <span class="comment">// 指定主窗口的句柄，钩子函数会向这个窗口发送通知信息。</span></div><div class="line">&#123;</div><div class="line">    BOOL bOk;</div><div class="line">    g_hWndCaller = hWndCaller;</div><div class="line">    <span class="keyword">if</span>(bInstall)</div><div class="line">    &#123;</div><div class="line">        g_hHook = SetWindowsHookEx(</div><div class="line">            WH_KEYBOARD,</div><div class="line">            KeyHookProc,</div><div class="line">            ModuleFromAddress(KeyHookProc),</div><div class="line">            dwThreadId);</div><div class="line">        bOk = (g_hHook != <span class="literal">NULL</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        bOk = UnhookWindowsHookEx(g_hHook);</div><div class="line">        g_hHook = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> bOk;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 键盘钩子函数</span></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyHookProc</span><span class="params">(<span class="keyword">int</span> nCode, WPARAM wParam, LPARAM lParam)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span>(nCode&lt;<span class="number">0</span> || nCode == HC_NOREMOVE )</div><div class="line">        <span class="keyword">return</span> CallNextHookEx(g_hHook,nCode,wParam,lParam);</div><div class="line">    <span class="keyword">if</span>(lParam &amp; <span class="number">0x40000000</span>) <span class="comment">// 消息重复就交给下一个HOOK链</span></div><div class="line">        <span class="keyword">return</span> CallNextHookEx(g_hHook,nCode,wParam,lParam);</div><div class="line"></div><div class="line">    <span class="comment">// 通知主窗口。wParam参数为虚拟键码，lParam包含了此键的信息</span></div><div class="line">    ::PostMessage(g_hWndCaller,HM_KEY,wParam,lParam);</div><div class="line">    <span class="keyword">return</span> CallNextHookEx(g_hHook,nCode,wParam,lParam);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// keyhooklib.def</div><div class="line">EXPORTS</div><div class="line">    SetKeyHook</div><div class="line">SECTIONS</div><div class="line">    YCIShared    Read Write Shared</div></pre></td></tr></table></figure>
<ul>
<li><strong>应用</strong></li>
</ul>
<p>以对话框为基础建立工程（keyhookapp），改动的文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div></pre></td><td class="code"><pre><div class="line">// KeyHookAppDlg.cpp : implementation file</div><div class="line">//</div><div class="line"></div><div class="line">#include &quot;stdafx.h&quot;</div><div class="line">#include &quot;KeyHookApp.h&quot;</div><div class="line">#include &quot;KeyHookAppDlg.h&quot;</div><div class="line">#include &quot;KeyHookLib.h&quot;</div><div class="line">#pragma comment(lib,&quot;KeyHookLib&quot;)</div><div class="line"></div><div class="line">#ifdef _DEBUG</div><div class="line">#define new DEBUG_NEW</div><div class="line">#undef THIS_FILE</div><div class="line">static char THIS_FILE[] = __FILE__;</div><div class="line">#endif</div><div class="line"></div><div class="line">/////////////////////////////////////////////////////////////////////////////</div><div class="line">// CAboutDlg dialog used for App About</div><div class="line"></div><div class="line">class CAboutDlg : public CDialog</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    CAboutDlg();</div><div class="line"></div><div class="line">    // Dialog Data</div><div class="line">    enum &#123; IDD = IDD_ABOUTBOX &#125;;</div><div class="line"></div><div class="line">    // ClassWizard generated virtual function overrides</div><div class="line">    protected:</div><div class="line">    virtual void DoDataExchange(CDataExchange* pDX);    // DDX/DDV support</div><div class="line"></div><div class="line">    // Implementation</div><div class="line">protected:</div><div class="line">    DECLARE_MESSAGE_MAP()</div><div class="line">&#125;;</div><div class="line"></div><div class="line">CAboutDlg::CAboutDlg() : CDialog(CAboutDlg::IDD)</div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CAboutDlg::DoDataExchange(CDataExchange* pDX)</div><div class="line">&#123;</div><div class="line">    CDialog::DoDataExchange(pDX);</div><div class="line">&#125;</div><div class="line"></div><div class="line">BEGIN_MESSAGE_MAP(CAboutDlg, CDialog)</div><div class="line">END_MESSAGE_MAP()</div><div class="line"></div><div class="line">/////////////////////////////////////////////////////////////////////////////</div><div class="line">// CKeyHookAppDlg dialog</div><div class="line"></div><div class="line">CKeyHookAppDlg::CKeyHookAppDlg(CWnd* pParent /*=NULL*/)</div><div class="line">    : CDialog(CKeyHookAppDlg::IDD, pParent)</div><div class="line">&#123;</div><div class="line">    // Note that LoadIcon does not require a subsequent DestroyIcon in Win32</div><div class="line">    m_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CKeyHookAppDlg::DoDataExchange(CDataExchange* pDX)</div><div class="line">&#123;</div><div class="line">    CDialog::DoDataExchange(pDX);</div><div class="line">&#125;</div><div class="line"></div><div class="line">BEGIN_MESSAGE_MAP(CKeyHookAppDlg, CDialog)</div><div class="line">    ON_WM_SYSCOMMAND()</div><div class="line">    ON_WM_PAINT()</div><div class="line">    ON_WM_QUERYDRAGICON()</div><div class="line">    ON_MESSAGE(HM_KEY,OnHookKey)</div><div class="line">END_MESSAGE_MAP()</div><div class="line"></div><div class="line">/////////////////////////////////////////////////////////////////////////////</div><div class="line">// CKeyHookAppDlg message handlers</div><div class="line"></div><div class="line">BOOL CKeyHookAppDlg::OnInitDialog()</div><div class="line">&#123;</div><div class="line">    CDialog::OnInitDialog();</div><div class="line"></div><div class="line">    // Add &quot;About...&quot; menu item to system menu.</div><div class="line"></div><div class="line">    // IDM_ABOUTBOX must be in the system command range.</div><div class="line">    ASSERT((IDM_ABOUTBOX &amp; 0xFFF0) == IDM_ABOUTBOX);</div><div class="line">    ASSERT(IDM_ABOUTBOX &lt; 0xF000);</div><div class="line"></div><div class="line">    CMenu* pSysMenu = GetSystemMenu(FALSE);</div><div class="line">    if (pSysMenu != NULL)</div><div class="line">    &#123;</div><div class="line">        CString strAboutMenu;</div><div class="line">        strAboutMenu.LoadString(IDS_ABOUTBOX);</div><div class="line">        if (!strAboutMenu.IsEmpty())</div><div class="line">        &#123;</div><div class="line">            pSysMenu-&gt;AppendMenu(MF_SEPARATOR);</div><div class="line">            pSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Set the icon for this dialog.  The framework does this automatically</div><div class="line">    //  when the application&apos;s main window is not a dialog</div><div class="line">    SetIcon(m_hIcon, TRUE);            // Set big icon</div><div class="line">    SetIcon(m_hIcon, FALSE);        // Set small icon</div><div class="line">    </div><div class="line">    // TODO: Add extra initialization here</div><div class="line"></div><div class="line">    // 安装钩子</div><div class="line">    if(!SetKeyHook(TRUE,0,m_hWnd))</div><div class="line">        MessageBox(&quot;安装钩子失败&quot;);</div><div class="line"></div><div class="line">    </div><div class="line">    return TRUE;  // return TRUE  unless you set the focus to a control</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CKeyHookAppDlg::OnSysCommand(UINT nID, LPARAM lParam)</div><div class="line">&#123;</div><div class="line">    if ((nID &amp; 0xFFF0) == IDM_ABOUTBOX)</div><div class="line">    &#123;</div><div class="line">        CAboutDlg dlgAbout;</div><div class="line">        dlgAbout.DoModal();</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        CDialog::OnSysCommand(nID, lParam);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// If you add a minimize button to your dialog, you will need the code below</div><div class="line">//  to draw the icon.  For MFC applications using the document/view model,</div><div class="line">//  this is automatically done for you by the framework.</div><div class="line"></div><div class="line">void CKeyHookAppDlg::OnPaint() </div><div class="line">&#123;</div><div class="line">    if (IsIconic())</div><div class="line">    &#123;</div><div class="line">        CPaintDC dc(this); // device context for painting</div><div class="line"></div><div class="line">        SendMessage(WM_ICONERASEBKGND, (WPARAM) dc.GetSafeHdc(), 0);</div><div class="line"></div><div class="line">        // Center icon in client rectangle</div><div class="line">        int cxIcon = GetSystemMetrics(SM_CXICON);</div><div class="line">        int cyIcon = GetSystemMetrics(SM_CYICON);</div><div class="line">        CRect rect;</div><div class="line">        GetClientRect(&amp;rect);</div><div class="line">        int x = (rect.Width() - cxIcon + 1) / 2;</div><div class="line">        int y = (rect.Height() - cyIcon + 1) / 2;</div><div class="line"></div><div class="line">        // Draw the icon</div><div class="line">        dc.DrawIcon(x, y, m_hIcon);</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        CDialog::OnPaint();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// The system calls this to obtain the cursor to display while the user drags</div><div class="line">//  the minimized window.</div><div class="line">HCURSOR CKeyHookAppDlg::OnQueryDragIcon()</div><div class="line">&#123;</div><div class="line">    return (HCURSOR) m_hIcon;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CKeyHookAppDlg::OnCancel() </div><div class="line">&#123;</div><div class="line">    // TODO: Add extra cleanup here</div><div class="line">    // 卸载钩子</div><div class="line">    SetKeyHook(FALSE);</div><div class="line">    CDialog::OnCancel();</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CKeyHookAppDlg::OnOK() </div><div class="line">&#123;</div><div class="line">    // TODO: Add extra validation here</div><div class="line">    // 卸载钩子</div><div class="line">    SetKeyHook(FALSE);</div><div class="line">    CDialog::OnOK();</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 钩子消息处理函数</div><div class="line">long CKeyHookAppDlg::OnHookKey(WPARAM wParam,LPARAM lParam)</div><div class="line">&#123;</div><div class="line">    // 此时wParam为用户按键的虚拟键码</div><div class="line">    // lParam包含按键的重复次数，扫描码，前一个按键状态等信息</div><div class="line">    // 取得按键名称。lParam是键盘消息的第二个参数</div><div class="line">    char szKey[80];</div><div class="line">    ::GetKeyNameText(lParam,szKey,80);</div><div class="line">    CString strItem;</div><div class="line">    strItem.Format(&quot;用户按键：%s &quot;,szKey);</div><div class="line"></div><div class="line">    // 添加到编辑框</div><div class="line">    CString strEdit;</div><div class="line">    GetDlgItem(IDC_KEY)-&gt;GetWindowText(strEdit);</div><div class="line">    GetDlgItem(IDC_KEY)-&gt;SetWindowText(strItem+strEdit);</div><div class="line">    ::MessageBeep(MB_OK);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p>一个对话框，检测当前键盘的状态。若有按键按下，则在对话框的EDIT控件中显示按下键的名字。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2008/02/27/simple-game-engine/" itemprop="url">
                  游戏引擎的简单实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2008-02-27T00:00:00+08:00" content="2008-02-27">
              2008-02-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/游戏开发/" itemprop="url" rel="index">
                    <span itemprop="name">游戏开发</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2008/02/27/simple-game-engine/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2008/02/27/simple-game-engine/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>游戏引擎负责处理各种琐碎事务：组件游戏，确保它正确运行及关闭它。将游戏分解为事件：</p>
<p>下面这些事件只适用于任何游戏的部分核心事件：</p>
<ul>
<li><strong>初始化</strong></li>
<li><strong>启动</strong></li>
<li><strong>结束</strong></li>
<li><strong>激活</strong></li>
<li><strong>停用</strong></li>
<li><strong>绘制</strong></li>
<li><strong>循环</strong></li>
</ul>
<p>初始化事件在一开始运行游戏时发生，这时游戏执行重要的初始设置任务，包括创建游戏引擎本身。启动和结束事件对应于游戏的开始和结束，这时很适合执行与特定的游戏会话相关联的初始化和清理任务。在最小化游戏或者将其发送至后台，然后在恢复时，就将发生激活和停用事件。当游戏需要绘制自身时，将发送绘制事件，类似于WINDOWS WM_PAINT 消息。最后，循环事件使游戏执行一个单独的游戏周期，它非常重要。</p>
<p><strong>游戏的计时机制</strong>：</p>
<p>游戏在指定的时间内运行的周期越多，看起来就越平滑。事实上，大多数游戏设置都在15 － 16周期每秒的范围内，最快的速度可能达到30周期每秒，比电影还快。除了极少数的一些情况外，应该力求达到的最低速度设置为12周期每秒。</p>
<p><strong>游戏引擎的类</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GAMEENGINE_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _GAMEENGINE_H</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">//游戏事件</span></div><div class="line"><span class="function">BOOL <span class="title">GameInitialize</span><span class="params">(HINSTANCE hInstance)</span></span>;     <span class="comment">//初始化</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameStart</span><span class="params">(HWND hWnd)</span></span>;                    <span class="comment">//启动</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameEnd</span><span class="params">()</span></span>;                               <span class="comment">//结束</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameActivate</span><span class="params">(HWND hWnd)</span></span>;                 <span class="comment">//激活</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameDeactivate</span><span class="params">(HWND hWnd)</span></span>;               <span class="comment">//停用</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GamePaint</span><span class="params">(HDC hdc)</span></span>;                      <span class="comment">//绘制</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameCycle</span><span class="params">()</span></span>;                             <span class="comment">//循环</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//游戏引擎类</span></div><div class="line"><span class="keyword">class</span> GameEngine</div><div class="line">&#123;</div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keyword">static</span> GameEngine * m_pGameEngine;        <span class="comment">//指向自身的静态指针</span></div><div class="line">    HINSTANCE           m_hInstance;          <span class="comment">//实例句柄</span></div><div class="line">    HWND                m_hWnd;               <span class="comment">//窗口句柄</span></div><div class="line">    TCHAR               m_szWndClass[<span class="number">32</span>];     <span class="comment">//窗口类名</span></div><div class="line">    TCHAR               m_szTitle[<span class="number">32</span>];        <span class="comment">//标题</span></div><div class="line">    WORD                m_wIcon,m_wSmallIcon; <span class="comment">//大小图标</span></div><div class="line">    <span class="keyword">int</span>                 m_iWidth,m_iHeight;   <span class="comment">//游戏区的宽和高</span></div><div class="line">    <span class="keyword">int</span>                 m_iFrameDelay;        <span class="comment">//帧的延迟时间(ms)</span></div><div class="line">    BOOL                m_bSleep;             <span class="comment">//休眠状态</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    GameEngine(HINSTANCE hInstance,LPTSTR szWndClass,LPTSTR szTitle,</div><div class="line">               WORD wIcon,WORD wSmallIcon,<span class="keyword">int</span> iWidth=<span class="number">640</span>,<span class="keyword">int</span> iHeight=<span class="number">480</span>);</div><div class="line">    ~GameEngine();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> GameEngine * <span class="title">GetEngine</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_pGameEngine;&#125;;</div><div class="line">    <span class="function">BOOL   <span class="title">Initialize</span><span class="params">(<span class="keyword">int</span> iCmdShow)</span></span>;</div><div class="line">    <span class="function">LRESULT <span class="title">HandlEvent</span><span class="params">(HWND hWnd,UINT msg,WPARAM wParam,LPARAM lParam)</span></span>;</div><div class="line">    </div><div class="line">    <span class="function">HINSTANCE   <span class="title">GetInstance</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_hInstance ;&#125;;</div><div class="line">    <span class="function">HWND        <span class="title">GetWindow</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_hWnd;&#125;;</div><div class="line">    <span class="function"><span class="keyword">void</span>        <span class="title">SetWindow</span><span class="params">(HWND hWnd)</span></span>&#123; m_hWnd=hWnd ;&#125;;</div><div class="line">    <span class="function">LPSTR       <span class="title">GetTitle</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> m_szTitle ;&#125;;</div><div class="line">    <span class="function">WORD        <span class="title">GetIcon</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_wIcon;&#125;;</div><div class="line">    <span class="function">WORD        <span class="title">GetSmallIcon</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_wSmallIcon; &#125;;</div><div class="line">    <span class="function"><span class="keyword">int</span>         <span class="title">GetWidth</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_iWidth;&#125;;</div><div class="line">    <span class="function"><span class="keyword">int</span>         <span class="title">GetHeight</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_iHeight;&#125;;</div><div class="line">    <span class="function"><span class="keyword">int</span>         <span class="title">GetFrameDelay</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> m_iFrameDelay ;&#125;;</div><div class="line">    <span class="function"><span class="keyword">void</span>        <span class="title">SetFrameDelay</span><span class="params">(<span class="keyword">int</span> iFrameRate)</span></span>&#123; m_iFrameDelay=<span class="number">1000</span>/iFrameRate;&#125;;</div><div class="line">    <span class="function">BOOL        <span class="title">GetSleep</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> m_bSleep;&#125;;</div><div class="line">    <span class="function"><span class="keyword">void</span>        <span class="title">SetSleep</span><span class="params">(BOOL bSleep)</span></span>&#123; m_bSleep=bSleep;&#125;;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd,UINT msg,WPARAM wParam,LPARAM lParam)</span></span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p><strong>其实现文件如下：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GameEngine.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//静态成员初始化</span></div><div class="line">GameEngine * GameEngine::m_pGameEngine=<span class="literal">NULL</span>;</div><div class="line"><span class="comment">//构造成员函数</span></div><div class="line">GameEngine::GameEngine(HINSTANCE hInstance,LPSTR szWndClass,LPSTR szTitle,</div><div class="line">                       WORD wIcon,WORD wSmallIcon,<span class="keyword">int</span> iWidth,<span class="keyword">int</span> iHeight)</div><div class="line">&#123;</div><div class="line">    m_pGameEngine=<span class="keyword">this</span>;</div><div class="line">    m_hInstance=hInstance;</div><div class="line">    m_hWnd=<span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span>(lstrlen(szWndClass)&gt;<span class="number">0</span>)</div><div class="line">        lstrcpy(m_szWndClass,szWndClass);</div><div class="line">    <span class="keyword">if</span>(lstrlen(szTitle)&gt;<span class="number">0</span>)</div><div class="line">        lstrcpy(m_szTitle,szTitle);</div><div class="line">    m_wIcon=wIcon;</div><div class="line">    m_wSmallIcon=wSmallIcon;</div><div class="line">    m_iWidth=iWidth;</div><div class="line">    m_iHeight=iHeight;</div><div class="line">    m_iFrameDelay=<span class="number">50</span>;  <span class="comment">//默认为20帧每妙</span></div><div class="line">    m_bSleep=TRUE;</div><div class="line">&#125;</div><div class="line"><span class="comment">//析构成员函数</span></div><div class="line">GameEngine::~GameEngine()</div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"><span class="comment">//引擎初始化</span></div><div class="line">BOOL GameEngine::Initialize(<span class="keyword">int</span> iCmdShow)</div><div class="line">&#123;</div><div class="line">    WNDCLASSEX  wc;</div><div class="line"></div><div class="line">    <span class="comment">//创建主窗口的类</span></div><div class="line">    wc.cbSize=<span class="keyword">sizeof</span>(WNDCLASSEX);</div><div class="line">    wc.style=CS_HREDRAW|CS_VREDRAW;</div><div class="line">    wc.lpfnWndProc=WndProc;</div><div class="line">    wc.cbClsExtra=<span class="number">0</span>;</div><div class="line">    wc.cbWndExtra=<span class="number">0</span>;</div><div class="line">    wc.hbrBackground=(HBRUSH)(COLOR_WINDOW+<span class="number">1</span>);</div><div class="line">    wc.hCursor=LoadCursor(<span class="literal">NULL</span>,IDC_ARROW);</div><div class="line">    wc.hIcon=LoadIcon(m_hInstance,MAKEINTRESOURCE(GetIcon()));</div><div class="line">    wc.hIconSm=LoadIcon(m_hInstance,MAKEINTRESOURCE(GetSmallIcon()));</div><div class="line">    wc.hInstance=m_hInstance;</div><div class="line">    wc.lpszClassName=m_szWndClass;</div><div class="line">    wc.lpszMenuName=<span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="comment">//注册窗口类</span></div><div class="line">    <span class="keyword">if</span>(!RegisterClassEx(&amp;wc))</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">    </div><div class="line">    <span class="comment">//根据游戏大小计算窗口大小和位置</span></div><div class="line">    <span class="keyword">int</span> iWindowWidth=m_iWidth+GetSystemMetrics(SM_CXFIXEDFRAME)*<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> iWindowHeight=m_iHeight+GetSystemMetrics(SM_CYFIXEDFRAME)*<span class="number">2</span>+GetSystemMetrics(SM_CYCAPTION);</div><div class="line">    <span class="keyword">if</span>(wc.lpszMenuName!=<span class="literal">NULL</span>)</div><div class="line">        iWindowHeight+=GetSystemMetrics(SM_CYMENU);</div><div class="line">    <span class="keyword">int</span> iXWindowPos=(GetSystemMetrics(SM_CXSCREEN)-iWindowWidth)/<span class="number">2</span>;</div><div class="line">    <span class="keyword">int</span> iYWindowPos=(GetSystemMetrics(SM_CYSCREEN)-iWindowHeight)/<span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="comment">//创建窗口</span></div><div class="line">    m_hWnd=CreateWindow(m_szWndClass,m_szTitle,WS_POPUPWINDOW|WS_CAPTION|WS_MINIMIZEBOX,iXWindowPos,iYWindowPos,</div><div class="line">                        iWindowWidth,iWindowHeight,<span class="literal">NULL</span>,<span class="literal">NULL</span>,m_hInstance,<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">if</span>(!m_hWnd)</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">    <span class="comment">//显示和更新窗口</span></div><div class="line">    ShowWindow(m_hWnd,iCmdShow);</div><div class="line">    UpdateWindow(m_hWnd);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div><div class="line"><span class="comment">//游戏消息处理函数</span></div><div class="line">LRESULT GameEngine::HandlEvent(HWND hWnd,UINT msg,WPARAM wParam,LPARAM lParam)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span>(msg)</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> WM_CREATE:</div><div class="line">        <span class="comment">//设置游戏窗口并开始游戏</span></div><div class="line">        SetWindow(hWnd);</div><div class="line">        GameStart(hWnd);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> WM_SETFOCUS:</div><div class="line">        <span class="comment">//激活游戏并更新休眠状态</span></div><div class="line">        GameActivate(hWnd);</div><div class="line">        SetSleep(FALSE);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> WM_KILLFOCUS:</div><div class="line">        <span class="comment">//停用游戏并更新休眠状态</span></div><div class="line">        GameDeactivate(hWnd);</div><div class="line">        SetSleep(TRUE);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> WM_PAINT:</div><div class="line">        HDC hDc;</div><div class="line">        PAINTSTRUCT ps;</div><div class="line">        hDc=BeginPaint(hWnd,&amp;ps);</div><div class="line">        <span class="comment">//绘制游戏</span></div><div class="line">        GamePaint(hDc);</div><div class="line">        EndPaint(hWnd,&amp;ps);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">case</span> WM_DESTROY:</div><div class="line">        <span class="comment">//结束游戏</span></div><div class="line">        GameEnd();</div><div class="line">        PostQuitMessage(<span class="number">0</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> DefWindowProc(hWnd,msg,wParam,lParam);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function">LRESULT CALLBACK <span class="title">WndProc</span><span class="params">(HWND hWnd,UINT msg,WPARAM wParam,LPARAM lParam)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> GameEngine::GetEngine()-&gt;HandlEvent(hWnd,msg,wParam,lParam);</div><div class="line">&#125;</div><div class="line"><span class="comment">//主函数入口</span></div><div class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance,HINSTANCE hPreInstance,PSTR szCommandLine,<span class="keyword">int</span> iCmdShow )</span></span></div><div class="line">&#123;   </div><div class="line">    MSG msg;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">int</span>  iTickTriger=<span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span>         iTickCount;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(GameInitialize(hInstance))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(!GameEngine::GetEngine()-&gt;Initialize(iCmdShow))</div><div class="line">            <span class="keyword">return</span> FALSE;</div><div class="line">        <span class="keyword">while</span>(TRUE)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span>(PeekMessage(&amp;msg,<span class="literal">NULL</span>,<span class="number">0</span>,<span class="number">0</span>,PM_REMOVE))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span>(msg.message==WM_QUIT)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                TranslateMessage(&amp;msg);</div><div class="line">                DispatchMessage(&amp;msg);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;   </div><div class="line">                <span class="comment">//确保游戏引擎没有休眠</span></div><div class="line">                <span class="keyword">if</span>(!GameEngine::GetEngine()-&gt;GetSleep())</div><div class="line">                &#123;</div><div class="line">                    <span class="comment">//检查滴答计数,查看是否经历了一个周期</span></div><div class="line">                    iTickCount=GetTickCount();</div><div class="line">                    <span class="keyword">if</span>(iTickCount&gt;iTickTriger)</div><div class="line">                    &#123;</div><div class="line">                        iTickTriger=iTickCount+GameEngine::GetEngine()-&gt;GetFrameDelay();</div><div class="line">                        <span class="comment">//游戏循环</span></div><div class="line">                        GameCycle();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//游戏结束</span></div><div class="line">    GameEnd();</div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>其使用方法：</strong></p>
<p>xxx.h文件要先声明一个全局游戏引擎指针。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"resource.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"GameEngine.h"</span></span></div><div class="line"></div><div class="line">GameEngine * g_pGame; <span class="comment">//全局游戏引擎指针</span></div></pre></td></tr></table></figure>
<p>然后xxx.cpp文件包含该xxx.h文件，在实现相应的游戏事件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Blizzard.h"</span></span></div><div class="line"></div><div class="line"><span class="function">BOOL <span class="title">GameInitialize</span><span class="params">(HINSTANCE hInstance)</span></span></div><div class="line">&#123;</div><div class="line">    g_pGame=<span class="keyword">new</span> GameEngine(hInstance,TEXT(<span class="string">"PRIZE"</span>),TEXT(<span class="string">"PRIZE"</span>),IDI_PRIZE,IDI_PRIZE);</div><div class="line">    <span class="keyword">if</span>(g_pGame==<span class="literal">NULL</span>)</div><div class="line">        <span class="keyword">return</span> FALSE;</div><div class="line">    g_pGame-&gt;SetFrameDelay(<span class="number">15</span>);</div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameStart</span><span class="params">(HWND hWnd)</span></span></div><div class="line">&#123;</div><div class="line">    srand(GetTickCount());</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameEnd</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameActivate</span><span class="params">(HWND hWnd)</span></span></div><div class="line">&#123;</div><div class="line">    HDC hDc;</div><div class="line">    RECT rect;</div><div class="line">    GetClientRect(hWnd,&amp;rect);</div><div class="line">    hDc=GetDC(hWnd);</div><div class="line">    DrawText(hDc,<span class="string">"Here comes ...."</span>,<span class="number">-1</span>,&amp;rect,DT_SINGLELINE|DT_CENTER|DT_VCENTER);</div><div class="line">    ReleaseDC(hWnd,hDc);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameDeactivate</span><span class="params">(HWND hWnd)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GamePaint</span><span class="params">(HDC hdc)</span></span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameCycle</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    HDC hDc;</div><div class="line">    HWND hWnd=g_pGame-&gt;GetWindow();</div><div class="line">    hDc=GetDC(hWnd);</div><div class="line">    DrawIcon(hDc,rand()%g_pGame-&gt;GetWidth(),rand()%g_pGame-&gt;GetHeight(),(HICON)(WORD)GetClassLong(hWnd,GCL_HICON));</div><div class="line">    ReleaseDC(hWnd,hDc);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2007/07/15/electronic-clock-asm/" itemprop="url">
                  51汇编做的电子时钟
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2007-07-15T00:00:00+08:00" content="2007-07-15">
              2007-07-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/课程设计/" itemprop="url" rel="index">
                    <span itemprop="name">课程设计</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2007/07/15/electronic-clock-asm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2007/07/15/electronic-clock-asm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">SECOND EQU 20H      ;当前秒</div><div class="line">MINUTE EQU 21H      ;当前分</div><div class="line">HOUR   EQU 22H      ;当前时</div><div class="line">ALAMINU EQU 23H     ;闹钟分钟</div><div class="line">ALAHOUR EQU 24H     ;闹钟小时</div><div class="line">DAY    EQU 25H      ;当前日</div><div class="line">MONTH  EQU 26H      ;当前月</div><div class="line">YEAR  EQU 27H      ;当前年   </div><div class="line">WEEK   EQU 29H      ;星期</div><div class="line">STATE  EQU 30H      ;状态</div><div class="line">INTNUM EQU 31H      ;中断次数</div><div class="line">MONTHDAYS EQU 32H   ;月所对应的天数</div><div class="line">ALAON     EQU 33H   ;闹钟开关状态</div><div class="line">TEMP       EQU 34H  ;临时变量</div><div class="line">ALARM     EQU 35H   ;实事报时,该处存放的变量为1时报时</div><div class="line">;液晶模块的寄存器地址</div><div class="line">LCD_CMD_WR EQU  0</div><div class="line">LCD_DATA_WR EQU 1</div><div class="line">LCD_BUSY_RD EQU 2</div><div class="line">LCD_DATA_RD EQU 3</div><div class="line">;显示命令</div><div class="line">LCD_CLS  EQU 1            ;清楚屏幕并且置AC为0</div><div class="line">LCD_HOME EQU 2            ;显示返回到原始位置</div><div class="line">LCD_SETMODE EQU 4            ;设置模式</div><div class="line">LCD_SETVISIBLE EQU 8            ;开关控制</div><div class="line">LCD_SHIFT EQU 16           ;光标移位</div><div class="line">LCD_SETFUNCTION EQU 32           ;功能设置</div><div class="line">LCD_SETCGADDR EQU 64           ;设置CGRAM</div><div class="line">LCD_SETDDADDR EQU 128          ;设置DDRAM</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line"> ORG 0000H</div><div class="line"> LJMP MAIN                     ;跳往主程序</div><div class="line"> ORG 0003H</div><div class="line"> LJMP KEYDOWN                  ;键盘中断</div><div class="line"> ORG 000BH</div><div class="line"> LJMP TIMER                    ;定时中断</div><div class="line">MAIN: </div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;月份所对应的天数表  </div><div class="line">DAYNUM: DB    1FH,1CH,1FH,1EH,1FH,1EH,1FH,1FH,1EH,1FH,1EH,1FH</div><div class="line">;显示星期字符串</div><div class="line">MON:    DB  &apos;MON&apos;,0</div><div class="line">TUE:    DB  &apos;TUE&apos;,0</div><div class="line">WED:    DB  &apos;WED&apos;,0</div><div class="line">THU:    DB  &apos;THU&apos;,0</div><div class="line">FRI:    DB  &apos;FRI&apos;,0</div><div class="line">SAT:    DB  &apos;SAT&apos;,0</div><div class="line">SUN:    DB  &apos;SUN&apos;,0 </div><div class="line">ON :    DB  &apos;ON&apos; ,0</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line"> MOV   SP ,#40H</div><div class="line"> MOV   TMOD,#01H               ;设置为T0</div><div class="line"> LCALL INITIAL                 ;初始化内存数据</div><div class="line">        LCALL DIS_INI                 ;液晶显示初始化</div><div class="line">        MOV   A,#38H</div><div class="line"> LCALL WRCMD</div><div class="line"> SETB  ET0                     ;允许TO中断</div><div class="line"> SETB  EX0                     ;允许INTRO中断</div><div class="line"> MOV   IP,#02H                 ;设置定时器的中断优先于键盘中断</div><div class="line"> SETB  EA                      ;CPU 开中断</div><div class="line"> MOV   TH0,#3CH                ;装初始值</div><div class="line"> MOV   TL0,#0B0H</div><div class="line"> SETB  TCON.4                  ;启动T0</div><div class="line">HERE:</div><div class="line">        LCALL DISPLAY                 ;根据模式不同在LCD上显示</div><div class="line">        LJMP HERE</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;初始化子程序</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INITIAL:</div><div class="line">        PUSH ACC</div><div class="line"> MOV   INTNUM,#0AH              ;装入中断次数</div><div class="line"> CLR A                         ;初始化时间:00:00:00</div><div class="line"> MOV SECOND,A</div><div class="line"> MOV MINUTE,A</div><div class="line"> MOV HOUR  ,A                 </div><div class="line"> MOV ALAMINU ,A</div><div class="line"> MOV ALAHOUR ,A</div><div class="line"> MOV DAY ,#4                 ;初始化日期为:2007-7-4 星期3</div><div class="line"> MOV MONTH,#7</div><div class="line"> MOV YEAR,#7H               </div><div class="line"> MOV WEEK ,#3H</div><div class="line">        MOV STATE ,#0H               ;初始化状态为0</div><div class="line"> MOV ALAON,#00H               ;初始化闹钟关闭</div><div class="line"> MOV ALARM,#00H               ;初始化不报时</div><div class="line"> POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;键盘中断程序</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">KEYDOWN:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,P1                      ;读键盘的状态</div><div class="line">       ANL A,#1FH                    ;屏蔽高三位</div><div class="line">       MOV TEMP,A</div><div class="line">       LCALL D_10MS                  ;延时10ms</div><div class="line">       MOV A,P1                      ;再次读入按键状态</div><div class="line">       ANL A,#1FH</div><div class="line">       CJNE A,TEMP,RET_KEY           ;两次不等,则是抖动引起的</div><div class="line">       CJNE A,#1EH,KEYDOWN1</div><div class="line">       LCALL KEY_0</div><div class="line">       AJMP RET_KEY</div><div class="line">KEYDOWN1:</div><div class="line">       CJNE A,#1DH,KEYDOWN2</div><div class="line">       LCALL KEY_1</div><div class="line">       AJMP RET_KEY</div><div class="line">KEYDOWN2:</div><div class="line">       CJNE A,#1BH,KEYDOWN3</div><div class="line">       LCALL KEY_2</div><div class="line">       AJMP RET_KEY</div><div class="line">KEYDOWN3:</div><div class="line">       CJNE A,#17H,KEYDOWN4</div><div class="line">       LCALL KEY_3</div><div class="line">       AJMP RET_KEY</div><div class="line">KEYDOWN4:</div><div class="line">       CJNE A,#0FH,RET_KEY</div><div class="line">       LCALL KEY_4</div><div class="line">       AJMP RET_KEY</div><div class="line">RET_KEY:</div><div class="line">       POP  ACC</div><div class="line">RETI</div><div class="line">;;;;;延时程序10MS</div><div class="line">D_10MS:</div><div class="line">      MOV R5,#0FFH</div><div class="line">D_10MS1:</div><div class="line">      MOV R6,#0EEH</div><div class="line">D_10MS2:</div><div class="line">      NOP</div><div class="line">      DJNZ R6,D_10MS2</div><div class="line">      DJNZ R5,D_10MS1</div><div class="line">RET</div><div class="line">;;;;;;功能键按下,设置状态</div><div class="line">KEY_0:</div><div class="line">       PUSH ACC</div><div class="line">MOV P0,#00H</div><div class="line">       MOV A,STATE</div><div class="line">       INC A</div><div class="line">       CJNE A,#05H,KEY_0_RET</div><div class="line">       MOV A,#00H</div><div class="line">KEY_0_RET:</div><div class="line">       MOV STATE,A</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;</div><div class="line">KEY_1:</div><div class="line">;MOV P0,#01H</div><div class="line">       MOV R7,#01H             ;设置为增加(子程序的入口参数)</div><div class="line">       MOV A,STATE</div><div class="line">       CJNE A,#00H,KEY_1_1     </div><div class="line">       AJMP KEY_1_RET          ;状态0下无作用</div><div class="line">KEY_1_1: </div><div class="line">       CJNE A,#01H,KEY_1_2</div><div class="line">       LCALL INC_DEC_HOUR      ;状态1下小时加一</div><div class="line">       AJMP KEY_1_RET</div><div class="line">KEY_1_2:</div><div class="line">       CJNE A,#02H,KEY_1_3</div><div class="line">       LCALL INC_DEC_ALAHOUR   ;状态2下闹钟小时加一</div><div class="line">       AJMP KEY_1_RET</div><div class="line">KEY_1_3:</div><div class="line">       CJNE A,#03H,KEY_1_4</div><div class="line">       LCALL INC_DEC_MONTH     ;状态3下月加一</div><div class="line">       AJMP KEY_1_RET</div><div class="line">KEY_1_4:</div><div class="line">       CJNE A,#04H,KEY_1_RET</div><div class="line">       LCALL INC_DEC_YEAR      ;状态4下年加一</div><div class="line">KEY_1_RET:</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;</div><div class="line">KEY_2:</div><div class="line">;MOV P0,#02H</div><div class="line">       MOV R7,#01H             ;设置为增加(子程序的入口参数)</div><div class="line">       MOV A,STATE</div><div class="line">       CJNE A,#00H,KEY_2_1     </div><div class="line">       AJMP KEY_2_RET          ;状态0下无作用</div><div class="line">KEY_2_1: </div><div class="line">       CJNE A,#01H,KEY_2_2</div><div class="line">       LCALL INC_DEC_MINUTE    ;状态1下分钟加一</div><div class="line">       AJMP KEY_2_RET</div><div class="line">KEY_2_2:</div><div class="line">       CJNE A,#02H,KEY_2_3</div><div class="line">       LCALL INC_DEC_ALAMINU   ;状态2下闹钟分钟加一</div><div class="line">       AJMP KEY_2_RET</div><div class="line">KEY_2_3:</div><div class="line">       CJNE A,#03H,KEY_2_4</div><div class="line">       LCALL INC_DEC_DAY       ;状态3下日加一</div><div class="line">       AJMP KEY_2_RET</div><div class="line">KEY_2_4:</div><div class="line">       CJNE A,#04H,KEY_2_RET</div><div class="line">       LCALL INC_DEC_WEEK     ;状态4下星期加一</div><div class="line">KEY_2_RET:</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;</div><div class="line">KEY_3:</div><div class="line">;MOV P0,#03H</div><div class="line">       MOV R7,#00H             ;设置为减少(子程序的入口参数)</div><div class="line">       MOV A,STATE</div><div class="line">       CJNE A,#00H,KEY_3_1    </div><div class="line">       MOV ALARM,#01H          ;状态0下报时:设定报时开关</div><div class="line">       AJMP KEY_3_RET          </div><div class="line">KEY_3_1: </div><div class="line">       CJNE A,#01H,KEY_3_2</div><div class="line">       LCALL INC_DEC_HOUR      ;状态1下小时减一</div><div class="line">       AJMP KEY_3_RET</div><div class="line">KEY_3_2:</div><div class="line">       CJNE A,#02H,KEY_3_3</div><div class="line">       LCALL INC_DEC_ALAHOUR   ;状态2下闹钟小时减一</div><div class="line">       AJMP KEY_3_RET</div><div class="line">KEY_3_3:</div><div class="line">       CJNE A,#03H,KEY_3_4</div><div class="line">       LCALL INC_DEC_MONTH     ;状态3下月减一</div><div class="line">       AJMP KEY_3_RET</div><div class="line">KEY_3_4:</div><div class="line">       CJNE A,#04H,KEY_3_RET</div><div class="line">       LCALL INC_DEC_YEAR      ;状态4下年减一</div><div class="line">KEY_3_RET:</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;</div><div class="line">KEY_4:</div><div class="line">;MOV P0,#04H</div><div class="line">       MOV R7,#00H             ;设置为减(子程序的入口参数)</div><div class="line">       MOV A,STATE</div><div class="line">       CJNE A,#00H,KEY_4_1  </div><div class="line">       MOV R6,ALAON             ;状态0下,设定闹钟开关</div><div class="line">       CJNE R6,#01H,SET_ALAON_0</div><div class="line">       MOV  R6,#00H</div><div class="line">       AJMP SET_RET</div><div class="line">SET_ALAON_0:</div><div class="line">       MOV  R6,#01H</div><div class="line">SET_RET:</div><div class="line">       MOV  ALAON,R6</div><div class="line">       AJMP KEY_4_RET          </div><div class="line">KEY_4_1: </div><div class="line">       CJNE A,#01H,KEY_4_2</div><div class="line">       LCALL INC_DEC_MINUTE    ;状态1下分钟减一</div><div class="line">       AJMP KEY_4_RET</div><div class="line">KEY_4_2:</div><div class="line">       CJNE A,#02H,KEY_4_3</div><div class="line">       LCALL INC_DEC_ALAMINU   ;状态2下闹钟分钟减一</div><div class="line">       AJMP KEY_4_RET</div><div class="line">KEY_4_3:</div><div class="line">       CJNE A,#03H,KEY_4_4</div><div class="line">       LCALL INC_DEC_DAY       ;状态3下日减一</div><div class="line">       AJMP KEY_4_RET</div><div class="line">KEY_4_4:</div><div class="line">       CJNE A,#04H,KEY_4_RET</div><div class="line">       LCALL INC_DEC_WEEK     ;状态4下星期减一</div><div class="line">KEY_4_RET:</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;定时器中断服务程序</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">TIMER:</div><div class="line">        PUSH PSW</div><div class="line"> PUSH ACC</div><div class="line"> MOV  A,SECOND</div><div class="line"> MOV  TH0,#3CH                ;T0装初始值</div><div class="line"> MOV  TL0,#0B0H</div><div class="line"> DJNZ INTNUM,RETURN           ;1秒未到,返回</div><div class="line"> MOV  INTNUM,#0AH             ;重置中断次数</div><div class="line"> INC  A</div><div class="line"> CJNE A,#60,RETURN            ;是否到60秒,未到返回</div><div class="line">        MOV  A,#00H          ;秒计满清零</div><div class="line"> MOV  R7,#01H                 ;分钟加一</div><div class="line"> LCALL INC_DEC_MINUTE</div><div class="line">RETURN:</div><div class="line">        MOV  SECOND,A</div><div class="line"> POP  ACC</div><div class="line"> POP  PSW</div><div class="line">RETI</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,增加年 </div><div class="line">;         R7=0时,减少年</div><div class="line">;         年的范围: 2000-2099</div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_MONTH的子程序被调用</div><div class="line">;    2.用于调整年</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_YEAR:</div><div class="line">        PUSH ACC</div><div class="line"> CJNE R7,#01,DEC_YEAR</div><div class="line">INC_YEAR:</div><div class="line">        MOV A,YEAR</div><div class="line"> INC A</div><div class="line"> CJNE A,#100,RET_YEAR         ;到达100年时复位到00年</div><div class="line"> MOV A,0</div><div class="line"> AJMP RET_YEAR</div><div class="line">DEC_YEAR:</div><div class="line">        MOV A,YEAR</div><div class="line">        JZ DEC_YEAR1                 ;当前为0时,再减少则跳到99年</div><div class="line"> DEC A</div><div class="line"> AJMP RET_YEAR</div><div class="line">DEC_YEAR1:</div><div class="line">        MOV A,#99</div><div class="line">RET_YEAR:</div><div class="line">        MOV YEAR,A</div><div class="line"> POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,增加一月,若大于12月时相应的增加一年</div><div class="line">;         R7=0时,减少一月,若当前为1月时,再减少一月</div><div class="line">;                则是12月,同时年减一</div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_DAY的子程序被调用</div><div class="line">;    2.用于调整月,同时可以改变年</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_MONTH:</div><div class="line">        PUSH ACC</div><div class="line"> CJNE R7,#01,DEC_MONTH</div><div class="line">INC_MONTH:</div><div class="line">        MOV A,MONTH</div><div class="line"> INC A</div><div class="line"> CJNE A,#13,RET_MONTH</div><div class="line"> MOV R7,#01H</div><div class="line"> LCALL INC_DEC_YEAR</div><div class="line"> MOV A,#01H</div><div class="line"> AJMP RET_MONTH</div><div class="line">DEC_MONTH:</div><div class="line">        MOV A,MONTH</div><div class="line"> DEC A</div><div class="line"> CJNE A,#0H,RET_MONTH</div><div class="line"> MOV R7,#00H</div><div class="line"> LCALL INC_DEC_YEAR</div><div class="line"> MOV A,#12</div><div class="line">RET_MONTH:</div><div class="line">        MOV MONTH,A</div><div class="line"> POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,星期加一</div><div class="line">;         R7=0时,星期减一</div><div class="line">;         不影响其他</div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_DAY的子程序被调用</div><div class="line">;    2.用于调整星期</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_WEEK:</div><div class="line">       PUSH ACC</div><div class="line">       CJNE R7,#01,DEC_WEEK</div><div class="line">INC_WEEK:</div><div class="line">       MOV A,WEEK</div><div class="line">       INC A</div><div class="line">       CJNE A,#08H,RET_WEEK</div><div class="line">       MOV A,#01H</div><div class="line">       AJMP RET_WEEK</div><div class="line">DEC_WEEK:</div><div class="line">       MOV A,WEEK</div><div class="line">       DEC A</div><div class="line">       CJNE A,#0H,RET_WEEK</div><div class="line">       MOV A,#07H</div><div class="line">RET_WEEK:</div><div class="line">       MOV WEEK,A</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,日加一,根据当前的年月来改变月份</div><div class="line">;                同时星期加一.</div><div class="line">;         R7=0时,日减一,同时改变月份,年.星期</div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_HOUR的子程序被调用</div><div class="line">;    2.用于调整日</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_DAY:</div><div class="line">       PUSH ACC</div><div class="line">       CJNE R7,#01H,DEC_DAY</div><div class="line">INC_DAY:</div><div class="line">       MOV R7,#01H</div><div class="line">       LCALL INC_DEC_WEEK</div><div class="line">       MOV A,DAY</div><div class="line">       INC A</div><div class="line">       LCALL SETMONTHDAYS</div><div class="line">       MOV TEMP,MONTHDAYS</div><div class="line">       INC TEMP</div><div class="line">       CJNE A,TEMP,RET_DAY</div><div class="line">       MOV R7,#01H</div><div class="line">       LCALL INC_DEC_MONTH</div><div class="line">       MOV A,#01H</div><div class="line">       AJMP RET_DAY</div><div class="line">DEC_DAY:</div><div class="line">       MOV R7,#00H</div><div class="line">       LCALL INC_DEC_WEEK</div><div class="line">       MOV A,DAY</div><div class="line">       DEC A</div><div class="line">       CJNE A,#0H,RET_DAY</div><div class="line">       MOV A,#00H</div><div class="line">       LCALL INC_DEC_MONTH</div><div class="line">       LCALL SETMONTHDAYS</div><div class="line">       MOV A,MONTHDAYS</div><div class="line">RET_DAY:</div><div class="line">       MOV DAY,A</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,增加一小时,同时有需要则改变日(星期),月,年</div><div class="line">;         R7=0时,减少一小时,同时有需要则改变日(星期),月,年  </div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_MINUTE的子程序被调用</div><div class="line">;    2.用于调整当前小时        </div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_HOUR:</div><div class="line">       PUSH ACC</div><div class="line">       CJNE R7,#01H,DEC_HOUR</div><div class="line">INC_HOUR:</div><div class="line">       MOV A,HOUR</div><div class="line">       INC A</div><div class="line">       CJNE A,#24,RET_HOUR</div><div class="line">       MOV R7,#01H</div><div class="line">       LCALL INC_DEC_DAY</div><div class="line">       MOV A,#00H</div><div class="line">       AJMP RET_HOUR</div><div class="line">DEC_HOUR:</div><div class="line">       MOV A,HOUR</div><div class="line">       JZ DEC_HOUR1</div><div class="line">       DEC A</div><div class="line">       AJMP RET_HOUR</div><div class="line">DEC_HOUR1:</div><div class="line">       MOV R7,#00H</div><div class="line">       LCALL INC_DEC_DAY</div><div class="line">       MOV A,#23</div><div class="line">RET_HOUR:</div><div class="line">       MOV HOUR,A</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,增加一分钟,同时按需要改变小时...</div><div class="line">;         R7=0时,减少一分钟................</div><div class="line">;用途:</div><div class="line">;    1.作为定时服务程序的子程序被调用</div><div class="line">;    2.用于调整当前的分钟</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_MINUTE:</div><div class="line">      PUSH ACC </div><div class="line">      CJNE R7,#01H,DEC_MINUTE</div><div class="line">INC_MINUTE:</div><div class="line">      MOV A,MINUTE</div><div class="line">      INC A</div><div class="line">      CJNE A,#60,RET_MINUTE</div><div class="line">      MOV R7,#01H</div><div class="line">      LCALL INC_DEC_HOUR</div><div class="line">      MOV A,#00H</div><div class="line">      AJMP RET_MINUTE</div><div class="line">DEC_MINUTE:</div><div class="line">      MOV A,MINUTE</div><div class="line">      JZ DEC_MINUTE1</div><div class="line">      DEC A</div><div class="line">      AJMP RET_MINUTE</div><div class="line">DEC_MINUTE1:</div><div class="line">      MOV R7,#00H</div><div class="line">      LCALL INC_DEC_HOUR</div><div class="line">      MOV A,#59</div><div class="line">RET_MINUTE:</div><div class="line">      MOV MINUTE,A</div><div class="line">      POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数: R7</div><div class="line">;         R7=1时,闹钟小时增加一,不影响其他</div><div class="line">;         R7=1时,闹钟小时减少一.......</div><div class="line">;用途:</div><div class="line">;    1.作为INC_DEC_ALAMINU的子程序被调用</div><div class="line">;    2.用于调整闹钟的小时</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_ALAHOUR:</div><div class="line">       PUSH ACC</div><div class="line">       CJNE R7,#01H,DEC_ALAHOUR</div><div class="line">INC_ALAHOUR:</div><div class="line">       MOV A,ALAHOUR</div><div class="line">       INC A</div><div class="line">       CJNE A,#24,RET_ALAHOUR</div><div class="line">       MOV A,#00H</div><div class="line">       AJMP RET_ALAHOUR</div><div class="line">DEC_ALAHOUR:</div><div class="line">       MOV A,ALAHOUR</div><div class="line">       JZ DEC_ALAHOUR1</div><div class="line">       DEC A</div><div class="line">       AJMP RET_ALAHOUR</div><div class="line">DEC_ALAHOUR1:</div><div class="line">       MOV A,#23</div><div class="line">RET_ALAHOUR:</div><div class="line">       MOV ALAHOUR,A</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;入口参数:R7</div><div class="line">;         R7=1时,闹钟分钟加一,同时该改变闹钟小时</div><div class="line">;         R7=0时,闹钟分钟减一,..................</div><div class="line">;用途:</div><div class="line">;    1.用于调整闹钟的分钟</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">INC_DEC_ALAMINU:</div><div class="line">      PUSH ACC </div><div class="line">      CJNE R7,#01H,DEC_ALAMINU</div><div class="line">INC_ALAMINU:</div><div class="line">      MOV A,ALAMINU</div><div class="line">      INC A</div><div class="line">      CJNE A,#60,RET_ALAMINU</div><div class="line">      MOV R7,#01H</div><div class="line">      LCALL INC_DEC_ALAHOUR</div><div class="line">      MOV A,#00H</div><div class="line">      AJMP RET_ALAMINU</div><div class="line">DEC_ALAMINU:</div><div class="line">      MOV A,ALAMINU</div><div class="line">      JZ DEC_ALAMINU1</div><div class="line">      DEC A</div><div class="line">      AJMP RET_ALAMINU</div><div class="line">DEC_ALAMINU1:</div><div class="line">      MOV R7,#00H</div><div class="line">      LCALL INC_DEC_ALAHOUR</div><div class="line">      MOV A,#59</div><div class="line">RET_ALAMINU:</div><div class="line">      MOV ALAMINU,A</div><div class="line">      POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;求得当前月份所对应的天数</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">SETMONTHDAYS:</div><div class="line">        PUSH ACC</div><div class="line">        PUSH DPH</div><div class="line"> PUSH DPL</div><div class="line">        MOV  DPTR,#DAYNUM        ;获得月天数的表地址</div><div class="line"> MOV  A,MONTH             ;获得当前月份</div><div class="line"> MOV  R0,MONTH</div><div class="line"> DEC  A                   ;生成下标</div><div class="line"> MOVC A,@A+DPTR           ;取表中的值</div><div class="line"> MOV  MONTHDAYS,A         </div><div class="line"> CJNE R0,#2H,CONTINUE     ;不是二月份则取表中的值</div><div class="line"> MOV  A,YEAR              ;是二月份判断是否是闰年</div><div class="line">        MOV  B,#4H</div><div class="line"> DIV  AB</div><div class="line"> MOV  A,#00H</div><div class="line"> CJNE A,B,CONTINUE        ;是平年则跳转</div><div class="line">        INC  MONTHDAYS           ;是闰年二月份为29天</div><div class="line">CONTINUE:</div><div class="line"> POP  DPL</div><div class="line"> POP  DPH</div><div class="line"> POP  ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;显示子程序</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">DISPLAY:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,#LCD_SETVISIBLE+4 </div><div class="line">       LCALL WRCMD</div><div class="line">       MOV A,#LCD_HOME</div><div class="line">       LCALL WRCMD</div><div class="line">       MOV R5,STATE</div><div class="line">       CJNE R5,#00H,DIS_1</div><div class="line">       LCALL DISPLAY_0</div><div class="line">       AJMP DIS_RET</div><div class="line">DIS_1: </div><div class="line">       CJNE R5,#01H,DIS_2</div><div class="line">       LCALL DISPLAY_1</div><div class="line">       AJMP DIS_RET</div><div class="line">DIS_2:</div><div class="line">       CJNE R5,#02H,DIS_3</div><div class="line">       LCALL DISPLAY_2</div><div class="line">       AJMP DIS_RET</div><div class="line">DIS_3:</div><div class="line">       CJNE R5,#03H,DIS_4</div><div class="line">       LCALL DISPLAY_3</div><div class="line">       AJMP DIS_RET</div><div class="line">DIS_4: </div><div class="line">       CJNE R5,#04H,DIS_RET</div><div class="line">       LCALL DISPLAY_4</div><div class="line">DIS_RET:</div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;</div><div class="line">DISPLAY_0:</div><div class="line">       PUSH ACC</div><div class="line">       ;显示时间</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,HOUR</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       MOV A,#3AH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,MINUTE</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#3AH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,SECOND</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       ;显示年</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#32H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#30H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,YEAR</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       ;显示星期</div><div class="line">       MOV A,#LCD_SETDDADDR+64</div><div class="line">       LCALL WRCMD</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#20</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">           MOV A,WEEK</div><div class="line">       CJNE A,#01H,DIS_0_W1</div><div class="line">       MOV DPTR,#MON</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W1:</div><div class="line">       CJNE A,#02H,DIS_0_W2</div><div class="line">       MOV DPTR,#TUE</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W2:</div><div class="line">       CJNE A,#03H,DIS_0_W3</div><div class="line">       MOV DPTR,#WED</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W3:</div><div class="line">       CJNE A,#04H,DIS_0_W4</div><div class="line">       MOV DPTR,#THU</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W4:</div><div class="line">       CJNE A,#05H,DIS_0_W5</div><div class="line">       MOV DPTR,#FRI</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W5:</div><div class="line">       CJNE A,#06H,DIS_0_W6</div><div class="line">       MOV DPTR,#SAT</div><div class="line">       AJMP DIS_0_RET</div><div class="line">DIS_0_W6:</div><div class="line">       CJNE A,#07H,DIS_0_RET</div><div class="line">       MOV DPTR,#SUN</div><div class="line">DIS_0_RET:</div><div class="line">       LCALL WRSTR</div><div class="line">       ;显示日期</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,MONTH</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       MOV A,#2DH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,DAY</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       ;显示状态</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,ALAON</div><div class="line">       CJNE A,#01H,RET_DSP_0</div><div class="line">       MOV DPTR,#ON</div><div class="line">       LCALL WRSTR</div><div class="line">RET_DSP_0:</div><div class="line">       </div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;</div><div class="line">DISPLAY_1:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,#LCD_CLS</div><div class="line">       LCALL WRCMD</div><div class="line">       ;显示时间</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,HOUR</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       MOV A,#3AH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,MINUTE</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#3AH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,SECOND</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line"></div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">DISPLAY_2:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,#LCD_CLS</div><div class="line">       LCALL WRCMD</div><div class="line">       ;显示时间</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,ALAHOUR</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#3AH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,ALAMINU</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       POP  ACC</div><div class="line">   </div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;</div><div class="line">DISPLAY_3:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,#LCD_CLS</div><div class="line">       LCALL WRCMD</div><div class="line">       ;;;;;;;;;;;;;;;</div><div class="line">       ;显示日期</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#20H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,MONTH</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       </div><div class="line">       MOV A,#2DH</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,DAY</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line"> </div><div class="line">       POP ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">DISPLAY_4:</div><div class="line">       PUSH ACC</div><div class="line">       MOV A,#LCD_CLS</div><div class="line">       LCALL WRCMD</div><div class="line">       MOV A,#8BH</div><div class="line">       LCALL WRCMD</div><div class="line">       MOV A,#32H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#30H</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV R3,YEAR</div><div class="line">       LCALL GETCHAR</div><div class="line">       MOV A,R3</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,R4</div><div class="line">       LCALL WRCHAR</div><div class="line">       MOV A,#0C2H</div><div class="line">       LCALL WRCMD</div><div class="line">              MOV A,WEEK</div><div class="line">       CJNE A,#01H,DIS_4_W1</div><div class="line">       MOV DPTR,#MON</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W1:</div><div class="line">       CJNE A,#02H,DIS_4_W2</div><div class="line">       MOV DPTR,#TUE</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W2:</div><div class="line">       CJNE A,#03H,DIS_4_W3</div><div class="line">       MOV DPTR,#WED</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W3:</div><div class="line">       CJNE A,#04H,DIS_4_W4</div><div class="line">       MOV DPTR,#THU</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W4:</div><div class="line">       CJNE A,#05H,DIS_4_W5</div><div class="line">       MOV DPTR,#FRI</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W5:</div><div class="line">       CJNE A,#06H,DIS_4_W6</div><div class="line">       MOV DPTR,#SAT</div><div class="line">       AJMP DIS_4_RET</div><div class="line">DIS_4_W6:</div><div class="line">       CJNE A,#07H,DIS_4_RET</div><div class="line">       MOV DPTR,#SUN</div><div class="line">DIS_4_RET:</div><div class="line">       LCALL WRSTR</div><div class="line">       POP ACC </div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;获得x的显示码:</div><div class="line">; 入口参数: R3:存放要被转换的数字</div><div class="line">; 出口参数: R3:高位对应的显示码</div><div class="line">;           R4:低微对应的显示码</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">GETCHAR:</div><div class="line">       PUSH ACC</div><div class="line">       MOV  A,R3</div><div class="line">       MOV  B,#10</div><div class="line">       DIV  AB</div><div class="line">       ADD  A,#30H</div><div class="line">       MOV  R3,A</div><div class="line">       MOV  A,B</div><div class="line">       ADD  A,#30H</div><div class="line">       MOV  R4,A</div><div class="line">       POP  ACC</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;写以零结尾的字符串</div><div class="line">;  首地址在DPTR中</div><div class="line">wrstr: mov R0,#LCD_DATA_WR</div><div class="line">wrstr1: clr A</div><div class="line"> movc A,@A+DPTR</div><div class="line"> jz wrstr2</div><div class="line"> movx @R0,A</div><div class="line"> call wtbusy</div><div class="line"> inc DPTR</div><div class="line"> push DPL</div><div class="line"> push DPH</div><div class="line"> pop DPH</div><div class="line"> pop DPL </div><div class="line"> jmp wrstr1</div><div class="line">wrstr2: ret</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">;写命令,命令控制字在A中</div><div class="line">wrcmd: mov R0,#LCD_CMD_WR</div><div class="line"> movx @R0,A</div><div class="line"> jmp wtbusy</div><div class="line"></div><div class="line">;写字字符,字符的代码放在A中</div><div class="line">wrchar: mov R0,#LCD_DATA_WR</div><div class="line"> movx @R0,A</div><div class="line">;忙则等待</div><div class="line">wtbusy: mov R1,#LCD_BUSY_RD</div><div class="line"> movx A,@r1</div><div class="line"> jb ACC.7,wtbusy</div><div class="line"> ret</div><div class="line">;;;;;;;;;;;;;;;</div><div class="line">;液晶显示初始化</div><div class="line">;;;;;;;;;;;;;;;</div><div class="line">DIS_INI:</div><div class="line">       ACALL D_15MS</div><div class="line">       MOV A,30H</div><div class="line">       MOV R0,#LCD_CMD_WR</div><div class="line">       MOVX @R0,A</div><div class="line">       ACALL D_5MS</div><div class="line">       MOV A,#30H</div><div class="line">       MOV R0,#LCD_CMD_WR</div><div class="line">       MOVX @R0,A</div><div class="line">       ACALL D_5MS</div><div class="line">       MOV A,#30H</div><div class="line">       MOV R0,#LCD_CMD_WR</div><div class="line">       MOVX @R0,A</div><div class="line">       MOV A,#38H       ;功能设置</div><div class="line">       ACALL WRCMD</div><div class="line">       MOV A,#08H       ;关显示</div><div class="line">       ACALL WRCMD</div><div class="line">       MOV A,#01H       ;清屏</div><div class="line">       ACALL WRCMD</div><div class="line">       MOV A,#06H       ;设定输入方式</div><div class="line">       ACALL WRCMD</div><div class="line">       ACALL D_40US    </div><div class="line">       </div><div class="line">       MOV A,#10H      ;光标移位</div><div class="line">       ACALL WRCMD</div><div class="line">       MOV A,#0C0H     ;开显示</div><div class="line">       ACALL WRCMD</div><div class="line">RET</div><div class="line">;;;;;;;;</div><div class="line">D_40US:</div><div class="line">      MOV R1,#10</div><div class="line">D_40US_1:</div><div class="line">      NOP</div><div class="line">      DJNZ R1,D_40US_1     </div><div class="line">RET</div><div class="line">;;;;;;;</div><div class="line">D_5MS:</div><div class="line">     MOV R1,#10</div><div class="line">D_5MS_1:</div><div class="line">     MOV R2,#125</div><div class="line">D_5MS_2:</div><div class="line">     NOP</div><div class="line">     DJNZ R2,D_5MS_2</div><div class="line">     DJNZ R1,D_5MS_1</div><div class="line">RET</div><div class="line">;;;;;;</div><div class="line">D_15MS:</div><div class="line">     MOV R0,#3</div><div class="line">D_15MS_1:</div><div class="line">     NOP</div><div class="line">     DJNZ R0,D_15MS_1</div><div class="line">RET</div><div class="line">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</div><div class="line">END</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="David++" />
          <p class="site-author-name" itemprop="name">David++</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">92</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/david-pp" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/davidpp" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/gamelab" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/future_fighter/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2007 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David++</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"tiny-lab"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

  


</body>
</html>
